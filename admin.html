<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>JNK Admin Panel</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      background: #f4f4f4;
    }
    header {
      background: #2c3e50;
      color: #fff;
      padding: 20px;
      text-align: center;
    }
    h1 {
      margin: 0;
      font-size: 24px;
    }
    .container {
      padding: 20px;
    }
    .form-section {
      background: #fff;
      padding: 20px;
      margin-bottom: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .form-section h2 {
      margin-top: 0;
    }
    label {
      display: block;
      margin: 8px 0 4px;
    }
    input, select, button, textarea {
      width: 100%;
      padding: 8px;
      margin-bottom: 12px;
      border-radius: 4px;
      border: 1px solid #ccc;
    }
    button {
      background: #2c3e50;
      color: #fff;
      border: none;
      cursor: pointer;
    }
    button:hover {
      background: #34495e;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      background: #fff;
      margin-bottom: 20px;
    }
    table th, table td {
      padding: 10px;
      border: 1px solid #ddd;
      text-align: left;
    }
    table th {
      background: #f8f8f8;
    }
    .actions button {
      width: auto;
      margin-right: 5px;
    }
    .receipt {
      display: none;
      width: 50mm;
      height: 40mm;
      font-size: 12px;
      padding: 5px;
    }
    .receipt img {
      width: 30px;
      height: auto;
    }
    .pagination {
      margin: 10px 0;
      text-align: center;
    }
    .pagination button {
      margin: 0 2px;
    }
  </style>
</head>
<body>
  <header>
    <h1>JNK Express Padala - Admin Panel</h1>
  </header>
  <div class="container">
    <div class="form-section">
      <h2>Add Tracking Entry</h2>
      <form id="trackingForm">
        <label for="trackingNumber">Tracking Number</label>
        <input type="text" id="trackingNumber" required />

        <label for="customerName">Customer Name</label>
        <input type="text" id="customerName" required />

        <label for="barangay">Barangay</label>
        <input type="text" id="barangay" required />

        <label for="price">Price</label>
        <input type="number" id="price" required />

        <label for="status">Status</label>
        <select id="status">
          <option value="Package Received">Package Received</option>
          <option value="In Transit">In Transit</option>
          <option value="Out for Delivery">Out for Delivery</option>
          <option value="Delivered">Delivered</option>
        </select>

        <button type="submit">Save Entry</button>
        <button type="button" id="printReceipt">Print Receipt</button>
      </form>
    </div>

    <div class="form-section">
      <h2>Loyalty Registration</h2>
      <form id="loyaltyForm">
        <label for="loyaltyName">Customer Full Name</label>
        <input type="text" id="loyaltyName" required />
        <button type="submit">Register Loyalty Member</button>
      </form>
      <table id="loyaltyTable">
        <thead>
          <tr>
            <th>Name</th>
            <th>Points</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="form-section">
      <h2>Tracking Entries</h2>
      <input type="text" id="searchInput" placeholder="Search tracking..." />
      <table id="trackingTable">
        <thead>
          <tr>
            <th>Tracking Number</th>
            <th>Customer Name</th>
            <th>Barangay</th>
            <th>Price</th>
            <th>Status</th>
            <th>History</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <div class="pagination">
        <button id="prevPage">Previous</button>
        <span id="pageInfo"></span>
        <button id="nextPage">Next</button>
      </div>
    </div>
  </div>

  <!-- Hidden Receipt Template -->
  <div id="receipt" class="receipt">
    <img src="https://raw.githubusercontent.com/yourgithub/logo.png" alt="Logo" />
    <h3>JNK Express Padala</h3>
    <p id="r_trackingNumber"></p>
    <p id="r_customerName"></p>
    <p id="r_barangay"></p>
    <p id="r_price"></p>
    <p>Thank you for your support!</p>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_AUTH_DOMAIN",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_STORAGE_BUCKET",
      messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
      appId: "YOUR_APP_ID"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    let loyaltyMembers = [];

    function normalizeName(name) {
      return name.replace(/\(.*?\)/g, "").trim().toLowerCase();
    }

    async function loadLoyaltyMembers() {
      const snapshot = await db.collection("loyalty").get();
      loyaltyMembers = snapshot.docs.map(doc => ({
        id: doc.id,
        name: doc.data().name,
        points: doc.data().points || 0
      }));
      renderLoyaltyTable();
    }

    function renderLoyaltyTable() {
      const tbody = document.querySelector("#loyaltyTable tbody");
      tbody.innerHTML = "";
      loyaltyMembers.forEach(member => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${member.name}</td>
          <td>${member.points}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    document.getElementById("loyaltyForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const name = document.getElementById("loyaltyName").value.trim();
      if (!name) return;
      await db.collection("loyalty").add({ name, points: 0 });
      document.getElementById("loyaltyForm").reset();
      loadLoyaltyMembers();
    });
<!-- ============================= -->
<!-- Part 2 of 4 - Admin Panel -->
<!-- ============================= -->

            <!-- Search and Filter -->
            <div class="search-filter">
                <input type="text" id="searchInput" placeholder="Search by Tracking No, Name, Barangay, or Status" />
                <select id="statusFilter">
                    <option value="">All Statuses</option>
                    <option value="Package Received">Package Received</option>
                    <option value="In Transit">In Transit</option>
                    <option value="Out for Delivery">Out for Delivery</option>
                    <option value="Delivered">Delivered</option>
                </select>
                <button onclick="filterTable()">Apply Filter</button>
            </div>

            <!-- Table -->
            <div class="table-container">
                <table id="trackingTable">
                    <thead>
                        <tr>
                            <th>Tracking Number</th>
                            <th>Parcel Name</th>
                            <th>Customer Name</th>
                            <th>Barangay</th>
                            <th>Price</th>
                            <th>Status</th>
                            <th>Status History</th>
                            <th>Estimated Delivery</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="trackingTableBody">
                        <!-- Dynamic rows -->
                    </tbody>
                </table>
            </div>

            <!-- Pagination -->
            <div id="paginationControls" class="pagination"></div>

            <!-- Modals -->
            <div id="updateModal" class="modal">
                <div class="modal-content">
                    <span class="close" onclick="closeModal('updateModal')">&times;</span>
                    <h3>Update Tracking Entry</h3>
                    <input type="hidden" id="updateId" />
                    <label>Status</label>
                    <select id="updateStatus">
                        <option value="Package Received">Package Received</option>
                        <option value="In Transit">In Transit</option>
                        <option value="Out for Delivery">Out for Delivery</option>
                        <option value="Delivered">Delivered</option>
                    </select>
                    <button onclick="confirmUpdate()">Update</button>
                </div>
            </div>

            <div id="deleteModal" class="modal">
                <div class="modal-content">
                    <span class="close" onclick="closeModal('deleteModal')">&times;</span>
                    <h3>Confirm Delete</h3>
                    <input type="password" id="deletePassword" placeholder="Enter password" />
                    <button onclick="confirmDelete()">Delete</button>
                </div>
            </div>

            <!-- Loyalty Points Section -->
            <div class="loyalty-section">
                <h2>Loyalty Members</h2>
                <div class="form-container">
                    <input type="text" id="loyaltyName" placeholder="Complete Name" />
                    <button onclick="registerLoyalty()">Register Loyalty Member</button>
                </div>
                <div class="table-container">
                    <table id="loyaltyTable">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Points</th>
                            </tr>
                        </thead>
                        <tbody id="loyaltyTableBody">
                            <!-- Dynamic loyalty rows -->
                        </tbody>
                    </table>
                </div>
            </div>

        </main>
    </div>

    <script>
        // =========================
        // Firebase Initialization
        // =========================
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_PROJECT_ID.appspot.com",
            messagingSenderId: "YOUR_SENDER_ID",
            appId: "YOUR_APP_ID"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // =========================
        // Loyalty Functions
        // =========================
        async function registerLoyalty() {
            const name = document.getElementById('loyaltyName').value.trim();
            if (!name) return alert("Enter a name");

            const ref = db.collection("loyalty").doc(name.toUpperCase());
            const docSnap = await ref.get();
            if (!docSnap.exists) {
                await ref.set({ points: 0 });
            }
            document.getElementById('loyaltyName').value = "";
            loadLoyaltyMembers();
        }

        async function loadLoyaltyMembers() {
            const tbody = document.getElementById("loyaltyTableBody");
            tbody.innerHTML = "";
            const querySnap = await db.collection("loyalty").get();
            querySnap.forEach(doc => {
                const tr = document.createElement("tr");
                tr.innerHTML = `<td>${doc.id}</td><td>${doc.data().points}</td>`;
                tbody.appendChild(tr);
            });
        }

        async function addLoyaltyPoint(customerName) {
            // Normalize name (ignore anything in parentheses)
            let baseName = customerName.split("(")[0].trim().toUpperCase();

            const ref = db.collection("loyalty").doc(baseName);
            const docSnap = await ref.get();
            if (docSnap.exists) {
                let points = docSnap.data().points || 0;
                await ref.update({ points: points + 1 });
                loadLoyaltyMembers();
            }
        }

        // =========================
        // Tracking Entry Functions
        // =========================
        async function saveTrackingEntry() {
            const trackingNumber = document.getElementById("trackingNumber").value.trim();
            const parcelName = document.getElementById("parcelName").value.trim();
            const customerName = document.getElementById("customerName").value.trim();
            const barangay = document.getElementById("barangay").value.trim();
            const price = document.getElementById("price").value.trim();
            const status = document.getElementById("status").value;

            if (!trackingNumber || !parcelName || !customerName || !barangay) {
                return alert("Please fill all required fields.");
            }

            const entry = {
                trackingNumber,
                parcelName,
                customerName,
                barangay,
                price,
                status,
                statusHistory: [{ status, date: new Date().toISOString() }]
            };

            await db.collection("tracking").doc(trackingNumber).set(entry);

            // Add loyalty point if applicable
            await addLoyaltyPoint(customerName);

            alert("Tracking entry saved!");
            loadTrackingEntries();
        }

        async function loadTrackingEntries() {
            const tbody = document.getElementById("trackingTableBody");
            tbody.innerHTML = "";
            const querySnap = await db.collection("tracking").get();
            querySnap.forEach(doc => {
                const data = doc.data();
                const tr = document.createElement("tr");
                tr.innerHTML = `
                    <td>${data.trackingNumber}</td>
                    <td>${data.parcelName}</td>
                    <td>${data.customerName}</td>
                    <td>${data.barangay}</td>
                    <td>${data.price}</td>
                    <td>${data.status}</td>
                    <td>${data.statusHistory.map(h => h.status + " (" + new Date(h.date).toLocaleString() + ")").join("<br/>")}</td>
                    <td>${data.estimatedDelivery || ""}</td>
                    <td>
                        <button onclick="openUpdateModal('${doc.id}')">Update</button>
                        <button onclick="openDeleteModal('${doc.id}')">Delete</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }
            // Update loyalty points if applicable
            if (parcelName) {
              const cleanedParcelName = cleanName(parcelName);
              const loyaltyDocRef = doc(db, "loyaltyMembers", cleanedParcelName);
              const loyaltyDocSnap = await getDoc(loyaltyDocRef);
              if (loyaltyDocSnap.exists()) {
                const currentPoints = loyaltyDocSnap.data().points || 0;
                await updateDoc(loyaltyDocRef, {
                  points: currentPoints + 1
                });
                console.log(`Loyalty point added for ${cleanedParcelName}`);
              }
            }
          } catch (error) {
            console.error("Error saving tracking entry:", error);
          }
        }

        // Print Receipt
        function printReceipt(trackingNumber, parcelName, barangay, price) {
          const receiptWindow = window.open('', '_blank', 'width=400,height=600');
          receiptWindow.document.write(`
            <html>
              <head>
                <style>
                  body { font-family: Arial, sans-serif; font-size: 12px; text-align: center; }
                  .logo { max-width: 80px; margin-bottom: 5px; }
                  .title { font-size: 14px; font-weight: bold; }
                  .info { margin: 5px 0; }
                  .quote { margin-top: 8px; font-style: italic; font-size: 11px; }
                </style>
              </head>
              <body>
                <img src="https://raw.githubusercontent.com/johnaboumatta/jnk-assets/main/logo.png" class="logo" />
                <div class="title">JNK Express Padala</div>
                <div class="info">Tracking #: ${trackingNumber}</div>
                <div class="info">Parcel: ${parcelName}</div>
                <div class="info">Barangay: ${barangay}</div>
                <div class="info">Price: ₱${price}</div>
                <div class="quote">"Thank you for your support"</div>
              </body>
            </html>
          `);
          receiptWindow.document.close();
          receiptWindow.print();
        }

        // Handle Print and Save
        document.getElementById("printBtn").addEventListener("click", async () => {
          const parcelName = document.getElementById("parcelName").value;
          const barangay = document.getElementById("barangay").value;
          const price = document.getElementById("price").value;
          const trackingNumber = document.getElementById("trackingNumber").value;
          const status = document.getElementById("status").value;

          await saveTrackingEntry(trackingNumber, parcelName, barangay, price, status);
          printReceipt(trackingNumber, parcelName, barangay, price);
        });

        // Barcode Scanner Auto-Save and Print
        document.getElementById("trackingNumber").addEventListener("change", async (e) => {
          const trackingNumber = e.target.value.trim();
          const parcelName = document.getElementById("parcelName").value;
          const barangay = document.getElementById("barangay").value;
          const price = document.getElementById("price").value;
          const status = document.getElementById("status").value;

          if (trackingNumber) {
            await saveTrackingEntry(trackingNumber, parcelName, barangay, price, status);
            printReceipt(trackingNumber, parcelName, barangay, price);
          }
        });

        // Customer Name Auto-fill Barangay
        async function autoFillBarangay(name) {
          const cleanedName = cleanName(name);
          const customerRef = doc(db, "customers", cleanedName);
          const customerSnap = await getDoc(customerRef);
          if (customerSnap.exists()) {
            document.getElementById("barangay").value = customerSnap.data().barangay;
          }
        }

        document.getElementById("parcelName").addEventListener("change", async (e) => {
          const name = e.target.value.trim();
          if (name) {
            await autoFillBarangay(name);
          }
        });

        // Export to CSV by Date Range
        document.getElementById("exportBtn").addEventListener("click", async () => {
          const startDate = document.getElementById("startDate").value;
          const endDate = document.getElementById("endDate").value;

          if (!startDate || !endDate) {
            alert("Please select a date range.");
            return;
          }

          const q = query(
            collection(db, "trackingEntries"),
            where("timestamp", ">=", new Date(startDate)),
            where("timestamp", "<=", new Date(endDate))
          );

          const querySnapshot = await getDocs(q);
          let csvContent = "data:text/csv;charset=utf-8,Tracking Number,Parcel Name,Barangay,Price,Status,Timestamp\n";

          let itemCount = 0;
          querySnapshot.forEach((doc) => {
            const data = doc.data();
            const row = `${data.trackingNumber},${data.parcelName},${data.barangay},${data.price},${data.status},${data.timestamp.toDate()}\n`;
            csvContent += row;
            itemCount++;
          });

          csvContent += `\nTotal Items:,${itemCount}`;

          const encodedUri = encodeURI(csvContent);
          const link = document.createElement("a");
          link.setAttribute("href", encodedUri);
          link.setAttribute("download", "tracking_entries.csv");
          document.body.appendChild(link);
          link.click();
        });
      </script>
    </body>
  </html>
    <!-- Bulk Update Modal -->
    <div id="bulkUpdateModal" class="modal">
      <div class="modal-content">
        <span class="close" onclick="closeBulkUpdateModal()">&times;</span>
        <h2>Bulk Update Status</h2>
        <label for="bulkStatus">Select New Status:</label>
        <select id="bulkStatus">
          <option value="Package Received">Package Received</option>
          <option value="In Transit">In Transit</option>
          <option value="Out for Delivery">Out for Delivery</option>
          <option value="Delivered">Delivered</option>
          <option value="Returned">Returned</option>
        </select>
        <label for="bulkStartDate">Start Date:</label>
        <input type="date" id="bulkStartDate" />
        <label for="bulkEndDate">End Date:</label>
        <input type="date" id="bulkEndDate" />
        <button onclick="applyBulkUpdate()">Apply Update</button>
      </div>
    </div>

    <!-- Loyalty Members Modal -->
    <div id="loyaltyMembersModal" class="modal">
      <div class="modal-content">
        <span class="close" onclick="closeLoyaltyMembersModal()">&times;</span>
        <h2>Loyalty Members</h2>
        <table id="loyaltyTable">
          <thead>
            <tr>
              <th>Name</th>
              <th>Points</th>
            </tr>
          </thead>
          <tbody id="loyaltyTableBody"></tbody>
        </table>
      </div>
    </div>

    <script>
      // ================= LOYALTY POINTS FIX =================
      // Function to normalize names (removes extra tags like "(COD)")
      function normalizeName(name) {
        return name.replace(/\(.*?\)/g, "").trim().toLowerCase();
      }

      // When saving a tracking entry
      async function saveTrackingEntry(entry) {
        const docRef = await db.collection("tracking").add(entry);

        // Loyalty system check
        const loyaltySnap = await db.collection("loyaltyMembers").get();
        loyaltySnap.forEach(async (doc) => {
          const memberName = normalizeName(doc.data().name);
          const entryName = normalizeName(entry.customerName);

          if (memberName === entryName) {
            await db
              .collection("loyaltyMembers")
              .doc(doc.id)
              .update({
                points: (doc.data().points || 0) + 1,
              });
          }
        });
      }

      // Example save button
      document.getElementById("saveBtn").addEventListener("click", async () => {
        const entry = {
          customerName: document.getElementById("customerName").value,
          barangay: document.getElementById("barangay").value,
          price: parseFloat(document.getElementById("price").value) || 0,
          trackingNumber: document.getElementById("trackingNumber").value,
          status: document.getElementById("status").value,
          timestamp: new Date(),
        };
        await saveTrackingEntry(entry);
        alert("Tracking entry saved!");
      });
    </script>
  </body>
</html>
