<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>JNK Admin Panel</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
<!-- XLSX -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<!-- html2canvas & jsPDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<!-- Html5Qrcode -->
<script src="https://unpkg.com/html5-qrcode/minified/html5-qrcode.min.js"></script>
<style>
body { font-family: Arial, sans-serif; margin:0; padding:0; background:#f5f5f5; }
header { background:#004080; color:#fff; padding:10px; text-align:center; font-size:1.3em; }
nav { display:flex; gap:5px; padding:5px; background:#eee; }
nav button { flex:1; padding:8px; font-size:0.9em; cursor:pointer; }
section { display:none; padding:10px; }
section.active { display:block; }
.item { display:flex; justify-content:space-between; background:#fff; margin-bottom:5px; padding:5px; border-radius:4px; box-shadow:0 0 2px #ccc; }
.muted { color:#666; font-size:0.85em; }
.small { font-size:0.75em; }
input, select, button { padding:5px; margin:2px 0; }
#scannerContainer { display:none; position:relative; width:300px; height:300px; background:#000; }
</style>
</head>
<body>

<header>JNK Admin Panel</header>
<nav>
<button onclick="openTab('parcelsTab')">Parcels</button>
<button onclick="openTab('productsTab')">Products</button>
<button onclick="openTab('analyticsTab')">Analytics</button>
</nav>

<!-- ========================== PARCELS ========================== -->
<section id="parcelsTab" class="active">
<h2>Parcel Tracking</h2>
<div>
<label>Tracking #: <input id="parcelTracking"></label>
<label>Parcel Name: <input id="parcelName"></label>
<label>Barangay: <input id="parcelBarangay"></label>
<label>Price: <input id="parcelPrice"></label>
<label>Status:
<select id="parcelStatus">
<option>Package Received</option>
<option>In Transit</option>
<option>Delivered</option>
<option>Returned</option>
</select></label>
<button onclick="printParcelReceipt()">Print Receipt & Save</button>
</div>
<div id="parcelList"></div>
<div id="parcelScannerContainer"></div>
</section>

<!-- ========================== PRODUCTS ========================== -->
<section id="productsTab">
<h2>Product Management & Sales</h2>
<div>
<h3>Add/Edit Product</h3>
<label>Barcode: <input id="prodBarcode"></label>
<label>Name: <input id="prodName"></label>
<label>Category: <input id="prodCategory"></label>
<label>Price: <input id="prodPrice" type="number"></label>
<label>Stock: <input id="prodStock" type="number"></label>
<label>Notes: <input id="prodNotes"></label>
<button onclick="saveProduct()">Save Product</button>
<button onclick="exportProductsExcel()">Export Products</button>
</div>

<div>
<h3>Record Sale</h3>
<label>Barcode: <input id="saleBarcode"></label>
<label>Qty: <input id="saleQty" type="number" value="1"></label>
<label>Buyer: <input id="saleBuyer"></label>
<label>Note: <input id="saleNote"></label>
<button onclick="recordSale()">Record Sale</button>
<button onclick="startSaleScanner()">Scan to Sell</button>
<div id="scannerContainer"></div>
</div>

<div id="productList"></div>
<div id="salesList"></div>
</section>

<!-- ========================== ANALYTICS ========================== -->
<section id="analyticsTab">
<h2>Analytics</h2>
<div>
<label>From: <input type="date" id="anaFrom"></label>
<label>To: <input type="date" id="anaTo"></label>
<button onclick="loadAnalytics()">Load</button>
<button onclick="exportAnalyticsExcel()">Export Excel</button>
<button onclick="exportAnalyticsPDF()">Export PDF</button>
<button onclick="quickRange('today')">Today</button>
<button onclick="quickRange('week')">This Week</button>
<button onclick="quickRange('month')">This Month</button>
</div>
<div id="kpis">
<div>Total Parcels: <span id="kpiParcels"></span></div>
<div>Total Revenue: <span id="kpiRevenue"></span></div>
<div>Avg Price: <span id="kpiAvg"></span></div>
<div>Repeat Customers: <span id="kpiRepeat"></span></div>
</div>
<canvas id="chartParcels"></canvas>
<canvas id="chartRevenue"></canvas>
<canvas id="chartBarangay"></canvas>
<table id="topBarangaysTable"><thead><tr><th>Barangay</th><th>Parcels</th></tr></thead><tbody></tbody></table>
</section>

<script>
// ========================== TABS ==========================
function openTab(id){
  document.querySelectorAll('section').forEach(s=>s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
}

// ========================== FIREBASE INIT ==========================
const firebaseConfig = {
  apiKey: "YOUR_API_KEY",
  authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
  projectId: "YOUR_PROJECT_ID"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const PASSWORD = "admin123";

// ========================== PARCEL FUNCTIONS ==========================
let allEntries = [];
async function loadAllParcels(){
  const snap = await db.collection('tracking').orderBy('timestamp','desc').get();
  allEntries = snap.docs.map(d=>({id:d.id, ...d.data(), timestamp:d.data().timestamp?.toDate()}));
}
function printParcelReceipt(){
  const id = document.getElementById('parcelTracking').value.trim();
  const name = document.getElementById('parcelName').value.trim();
  const barangay = document.getElementById('parcelBarangay').value.trim();
  const price = document.getElementById('parcelPrice').value.trim();
  const status = document.getElementById('parcelStatus').value;

  if(!id) return alert('Tracking number required.');
  const docRef = db.collection('tracking').doc(id);
  const data = {
    parcelName:name, barangay, price:Number(price)||0,
    statusHistory:[{status,timestamp:firebase.firestore.Timestamp.now()}],
    timestamp:firebase.firestore.Timestamp.now()
  };
  docRef.set(data, {merge:true});
  
  const receiptWin = window.open('','_blank');
  receiptWin.document.write(`<pre style="font-family:monospace;text-align:center">
<img src="https://raw.githubusercontent.com/YOUR_USER/YOUR_REPO/main/logo.jpg" width="80">
JNK EXPRESS
----------------------------
Tracking #: ${id}
Name: ${name}
Barangay: ${barangay}
Price: ₱${price}
Status: ${status}
----------------------------
Thank you for your support
</pre>`);
  receiptWin.print();
  receiptWin.close();
  alert('Parcel saved and printed.');
  loadAllParcels();
}

// ========================== PRODUCTS ==========================
async function saveProduct(){
  const barcode = (document.getElementById('prodBarcode').value || '').trim();
  const name = (document.getElementById('prodName').value || '').trim();
  const category = (document.getElementById('prodCategory').value || '').trim();
  const price = Number(document.getElementById('prodPrice').value) || 0;
  const stock = Number(document.getElementById('prodStock').value) || 0;
  const notes = (document.getElementById('prodNotes').value || '').trim();
  if(!barcode || !name || !category) return alert('Barcode, name and category required.');

  await db.collection('products').doc(barcode).set({name, category, price, stock, notes, createdAt:firebase.firestore.Timestamp.now()}, {merge:true});
  document.getElementById('prodBarcode').value='';
  document.getElementById('prodName').value='';
  document.getElementById('prodCategory').value='';
  document.getElementById('prodPrice').value='';
  document.getElementById('prodStock').value='';
  document.getElementById('prodNotes').value='';
  loadProducts();
  alert('Product saved.');
}
async function loadProducts(){
  const list = document.getElementById('productList');
  const snap = await db.collection('products').orderBy('createdAt','desc').get();
  if(snap.empty){ list.innerHTML='<div>No products</div>'; return;}
  list.innerHTML='';
  snap.docs.forEach(d=>{
    const data=d.data();
    const el=document.createElement('div');
    el.className='item';
    el.innerHTML=`
      <div>
        <div style="font-weight:700">${d.id} - ${data.name}</div>
        <div class="muted small">Category:${data.category} | Price: ₱${data.price} | Stock: ${data.stock}</div>
        <div class="muted small">${data.notes||''}</div>
      </div>
      <div>
        <button onclick="editProduct('${d.id}')">Edit</button>
        <button onclick="deleteProduct('${d.id}')">Delete</button>
      </div>`;
    list.appendChild(el);
  });
}
async function editProduct(id){
  const doc=await db.collection('products').doc(id).get();
  if(!doc.exists) return alert('Product not found.');
  const d=doc.data();
  document.getElementById('prodBarcode').value=id;
  document.getElementById('prodName').value=d.name||'';
  document.getElementById('prodCategory').value=d.category||'';
  document.getElementById('prodPrice').value=d.price||'';
  document.getElementById('prodStock').value=d.stock||'';
  document.getElementById('prodNotes').value=d.notes||'';
}
async function deleteProduct(id){
  const confirmPass=prompt('Enter admin password to delete product:');
  if(confirmPass!==PASSWORD) return alert('Incorrect password.');
  await db.collection('products').doc(id).delete();
  loadProducts();
  alert('Deleted product.');
}

// SALES
let saleScanner;
async function recordSale(){
  const barcode=document.getElementById('saleBarcode').value.trim();
  const qty=Number(document.getElementById('saleQty').value)||1;
  const buyer=document.getElementById('saleBuyer').value.trim();
  const note=document.getElementById('saleNote').value.trim();
  if(!barcode||qty<=0) return alert('Barcode and positive qty required.');

  const prodRef=db.collection('products').doc(barcode);
  const snap=await prodRef.get();
  if(!snap.exists) return alert('Product not found.');
  const prod=snap.data();
  const price=Number(prod.price)||0;
  const total=price*qty;
  const sale={productId:barcode, productName:prod.name, category:prod.category, qty, price, total, buyer, note, timestamp:firebase.firestore.Timestamp.now()};
  await db.collection('sales').add(sale);

  // decrement stock
  await prodRef.update({stock:Math.max(0,(prod.stock||0)-qty)});

  // print receipt
  const win=window.open('','_blank');
  win.document.write(`<pre style="font-family:monospace;text-align:center">
URBAN FINDS by JNK
----------------------------
Product: ${prod.name}
Barcode: ${barcode}
Qty: ${qty}
Price: ₱${price}
Total: ₱${total}
Buyer: ${buyer}
${note ? 'Note: '+note : ''}
----------------------------
Thank you for your purchase
</pre>`);
  win.print();
  win.close();

  document.getElementById('saleBarcode').value='';
  document.getElementById('saleQty').value=1;
  document.getElementById('saleBuyer').value='';
  document.getElementById('saleNote').value='';
  loadProducts(); loadSales();
  alert('Sale recorded and printed.');
}
async function loadSales(){
  const list=document.getElementById('salesList');
  const snap=await db.collection('sales').orderBy('timestamp','desc').limit(50).get();
  if(snap.empty){ list.innerHTML='<div>No recent sales</div>'; return;}
  list.innerHTML='';
  snap.docs.forEach(d=>{
    const data=d.data();
    const el=document.createElement('div');
    el.className='item';
    el.innerHTML=`
      <div>
        <div style="font-weight:700">${data.productName} (${data.productId})</div>
        <div class="muted small">Qty: ${data.qty} | Price: ₱${data.price} | Total: ₱${data.total}</div>
        <div class="muted small">${data.buyer || ''} ${data.note ? '• '+data.note : ''}</div>
        <div class="muted small">${data.timestamp?.toDate ? data.timestamp.toDate().toLocaleString() : ''}</div>
      </div>`;
    list.appendChild(el);
  });
}
function startSaleScanner(){
  if(!saleScanner) saleScanner=new Html5Qrcode("scannerContainer");
  document.getElementById('scannerContainer').style.display='block';
  saleScanner.start({facingMode:"environment"},{fps:10,qrbox:250},decoded=>{
    document.getElementById('saleBarcode').value=decoded.trim();
    stopSaleScanner();
  },()=>{});
}
function stopSaleScanner(){
  document.getElementById('scannerContainer').style.display='none';
  if(saleScanner) saleScanner.stop().then(()=>saleScanner.clear()).catch(()=>{});
}

// Export Products
async function exportProductsExcel(){
  const snap=await db.collection('products').get();
  const aoa=[["Barcode","Name","Category","Price","Stock","Notes","CreatedAt"]];
  snap.docs.forEach(d=>{
    const x=d.data();
    aoa.push([d.id,x.name||'',x.category||'',x.price||0,x.stock||0,x.notes||'',x.createdAt?.toDate ? x.createdAt.toDate().toLocaleString():'']);
  });
  const ws=XLSX.utils.aoa_to_sheet(aoa);
  const wb=XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb,ws,"Products");
  XLSX.writeFile(wb,`products_${Date.now()}.xlsx`);
}

// INIT
function initOnLogin(){ loadProducts(); loadSales(); loadAllParcels(); }
initOnLogin();
db.collection && db.collection('products').onSnapshot && db.collection('products').onSnapshot(()=>loadProducts());
db.collection && db.collection('sales').onSnapshot && db.collection('sales').onSnapshot(()=>loadSales());
</script>
</body>
</html>
