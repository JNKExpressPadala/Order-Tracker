<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Admin Panel - JNK Express & Urban Finds</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

<!-- Chart.js for analytics -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body { font-family: Arial, sans-serif; margin:0; background:#f5f7fb; }
header { background:#2b3d52; color:#fff; padding:15px; text-align:center; font-size:20px; }
nav { display:flex; background:#34495e; }
nav button { flex:1; padding:12px; border:none; background:#34495e; color:#fff; cursor:pointer; }
nav button.active { background:#1abc9c; }
section { display:none; padding:20px; }
section.active { display:block; }
table { width:100%; border-collapse: collapse; margin-top:15px; background:#fff; }
th, td { border:1px solid #ddd; padding:10px; text-align:center; }
th { background:#2c3e50; color:#fff; }
tr.low-stock { background:#f8d7da; }
.form-inline input, .form-inline select { padding:6px; margin:3px; }
.btn { padding:8px 15px; border:none; cursor:pointer; margin:5px; }
.btn-primary { background:#1abc9c; color:#fff; }
.btn-danger { background:#e74c3c; color:#fff; }
.btn-secondary { background:#3498db; color:#fff; }
canvas { max-width:500px; margin:20px auto; display:block; }
.receipt-frame { display:none; }
</style>
</head>
<body>

<header>ðŸ“¦ Admin Panel - JNK Express & Urban Finds</header>

<nav>
  <button class="tab-btn active" data-tab="tracking">Parcel Tracking</button>
  <button class="tab-btn" data-tab="products">Products</button>
  <button class="tab-btn" data-tab="sales">JNK Products Sales</button>
</nav>

<section id="tracking" class="active">
<h2>Parcel Tracking</h2>
<div id="trackingArea">

<!-- PARCEL TRACKING FORM -->
<div class="form-inline">
<input type="text" id="parcelName" placeholder="Parcel Name">
<input type="text" id="parcelBarangay" placeholder="Barangay">
<input type="text" id="parcelTracking" placeholder="Tracking Number">
<input type="number" id="parcelPrice" placeholder="Price">
<select id="parcelStatus">
<option value="Package Received">Package Received</option>
<option value="In Transit">In Transit</option>
<option value="Out for Delivery">Out for Delivery</option>
<option value="Delivered">Delivered</option>
</select>
<button class="btn btn-primary" onclick="addParcel()">Add Parcel</button>
</div>

<!-- PARCELS TABLE -->
<table id="parcelsTable">
<thead>
<tr>
<th>Date</th>
<th>Tracking #</th>
<th>Parcel Name</th>
<th>Barangay</th>
<th>Price</th>
<th>Status</th>
<th>Actions</th>
</tr>
</thead>
<tbody></tbody>
</table>

<!-- PARCEL SEARCH / FILTER -->
<div class="form-inline">
<input type="text" id="searchParcel" placeholder="Search by tracking # or name">
<button class="btn btn-secondary" onclick="searchParcelFunc()">Search</button>
<button class="btn btn-secondary" onclick="clearSearch()">Clear</button>
</div>

<!-- EXISTING BULK UPDATE / EXPORT BUTTONS -->
<div class="form-inline">
<button class="btn btn-secondary" onclick="exportParcels()">Export Parcels CSV</button>
<button class="btn btn-secondary" onclick="bulkUpdateStatus()">Bulk Update Status</button>
</div>

<!-- Existing pagination controls -->
<div id="paginationControls" class="form-inline">
<button class="btn btn-secondary" onclick="prevPage()">Prev</button>
<span id="currentPage">1</span>
<button class="btn btn-secondary" onclick="nextPage()">Next</button>
</div>
</div> <!-- End of trackingArea -->
</section>

<!-- PRODUCTS SECTION -->
<section id="products">
<h2>Manage Products - Urban Finds by JNK</h2>
<div class="form-inline">
<input type="text" id="productName" placeholder="Product Name">
<input type="number" id="productCost" placeholder="Cost Price">
<input type="number" id="productPrice" placeholder="Selling Price">
<input type="number" id="productStock" placeholder="Stock Qty">
<button class="btn btn-primary" onclick="addOrUpdateProduct()">Add / Update</button>
</div>
<table id="productsTable">
<thead>
<tr>
<th>Name</th>
<th>Cost</th>
<th>Price</th>
<th>Stock</th>
<th>Action</th>
</tr>
</thead>
<tbody></tbody>
</table>
<button class="btn btn-secondary" onclick="exportProducts()">Export Products</button>
</section>

<!-- SALES SECTION -->
<section id="sales">
<h2>JNK Products Sales</h2>
<div class="form-inline">
<select id="saleProduct"></select>
<input type="number" id="saleQty" placeholder="Quantity" min="1">
<select id="salePayment">
<option value="Cash">Cash</option>
<option value="GCash">GCash</option>
<option value="Maya">Maya</option>
<option value="Credit">Credit</option>
</select>
<input type="text" id="saleCustomer" placeholder="Customer (optional)">
<button class="btn btn-primary" onclick="recordSale()">Record Sale & Print</button>
<button class="btn btn-secondary" onclick="exportSales()">Export Sales CSV</button>
</div>
<table id="salesTable">
<thead>
<tr>
<th>Date</th>
<th>Product</th>
<th>Qty</th>
<th>Price</th>
<th>Total</th>
<th>Payment</th>
<th>Customer</th>
</tr>
</thead>
<tbody></tbody>
</table>

<h3>Analytics</h3>
<canvas id="salesChart"></canvas>
<canvas id="paymentChart"></canvas>
</section>

<!-- Hidden iframe for receipt printing -->
<iframe id="receiptFrame" class="receipt-frame"></iframe>

<script>
// Firebase configuration
const firebaseConfig = {
apiKey: "AIzaSyAnrNfuTSRAKUS2tAU4AUUrauw_QzszCjY",
authDomain: "jnk-ordertracker.firebaseapp.com",
projectId: "jnk-ordertracker",
storageBucket: "jnk-ordertracker.firebasestorage.app",
messagingSenderId: "421193030070",
appId: "1:421193030070:web:078e39980237bc41f64917"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

// Tab switching
document.querySelectorAll('.tab-btn').forEach(btn=>{
btn.addEventListener('click',()=> {
document.querySelectorAll('section').forEach(sec=>sec.classList.remove('active'));
document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
document.getElementById(btn.dataset.tab).classList.add('active');
btn.classList.add('active');
});
});

// PARCEL TRACKING FUNCTIONS
function addParcel() {
// fetch values
const name = document.getElementById('parcelName').value;
const barangay = document.getElementById('parcelBarangay').value;
const tracking = document.getElementById('parcelTracking').value;
const price = parseFloat(document.getElementById('parcelPrice').value) || 0;
const status = document.getElementById('parcelStatus').value;
if(!name || !tracking) { alert('Name and Tracking required'); return; }
db.collection('parcels').add({
name, barangay, tracking, price, status, timestamp: firebase.firestore.FieldValue.serverTimestamp()
}).then(()=>{ alert('Parcel added'); loadParcels(); });
}
// Load parcels from Firestore
function loadParcels(){
  db.collection('parcels').orderBy('timestamp','desc').get().then(snapshot=>{
    const tbody = document.querySelector('#parcelsTable tbody');
    tbody.innerHTML='';
    snapshot.forEach(doc=>{
      const data = doc.data();
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${data.timestamp ? new Date(data.timestamp.seconds*1000).toLocaleString() : ''}</td>
        <td>${data.tracking}</td>
        <td>${data.name}</td>
        <td>${data.barangay}</td>
        <td>${data.price}</td>
        <td>${data.status}</td>
        <td>
          <button class="btn btn-primary" onclick="editParcel('${doc.id}')">Edit</button>
          <button class="btn btn-danger" onclick="deleteParcel('${doc.id}')">Delete</button>
        </td>
      `;
      tbody.appendChild(tr);
    });
  });
}

function searchParcelFunc(){
  const query = document.getElementById('searchParcel').value.toLowerCase();
  document.querySelectorAll('#parcelsTable tbody tr').forEach(tr=>{
    tr.style.display = tr.innerText.toLowerCase().includes(query)?'':'none';
  });
}
function clearSearch(){ document.getElementById('searchParcel').value=''; searchParcelFunc(); }

// Pagination (simple)
let currentPage=1; const itemsPerPage=10;
function prevPage(){ if(currentPage>1){currentPage--; renderPage(); }}
function nextPage(){ currentPage++; renderPage(); }
function renderPage(){/* implement page slicing if needed */}

// Bulk update
function bulkUpdateStatus(){ const newStatus = prompt('Enter new status:'); if(!newStatus) return;
db.collection('parcels').get().then(snapshot=>{
  snapshot.forEach(doc=>{ db.collection('parcels').doc(doc.id).update({status:newStatus}); });
  alert('Bulk update complete'); loadParcels();
});}

// Export parcels
function exportParcels(){/* implement CSV export */}

// PRODUCT FUNCTIONS
function addOrUpdateProduct(){
  const name=document.getElementById('productName').value;
  const cost=parseFloat(document.getElementById('productCost').value)||0;
  const price=parseFloat(document.getElementById('productPrice').value)||0;
  const stock=parseInt(document.getElementById('productStock').value)||0;
  if(!name){ alert('Product name required'); return; }
  // check if product exists
  db.collection('products').where('name','==',name).get().then(snapshot=>{
    if(snapshot.empty){
      db.collection('products').add({name,cost,price,stock}).then(()=>{ loadProducts(); });
    } else {
      snapshot.forEach(doc=>{
        db.collection('products').doc(doc.id).update({cost,price,stock:firebase.firestore.FieldValue.increment(stock)});
      });
    }
  });
}

function loadProducts(){
  db.collection('products').get().then(snapshot=>{
    const tbody = document.querySelector('#productsTable tbody');
    const selectSale = document.getElementById('saleProduct');
    tbody.innerHTML=''; selectSale.innerHTML='';
    snapshot.forEach(doc=>{
      const data = doc.data();
      const tr = document.createElement('tr');
      tr.innerHTML=`
        <td>${data.name}</td>
        <td>${data.cost}</td>
        <td>${data.price}</td>
        <td>${data.stock}</td>
        <td><button class="btn btn-danger" onclick="deleteProduct('${doc.id}')">Delete</button></td>
      `;
      tbody.appendChild(tr);
      const option = document.createElement('option'); option.value=data.name; option.text=data.name; selectSale.appendChild(option);
    });
  });
}
function deleteProduct(id){ if(confirm('Delete product?')) db.collection('products').doc(id).delete().then(()=>{ loadProducts(); }); }
// RECORD SALES & PRINT RECEIPT
function recordSale(){
  const productName=document.getElementById('saleProduct').value;
  const qty=parseInt(document.getElementById('saleQty').value)||1;
  const payment=document.getElementById('salePayment').value;
  const customer=document.getElementById('saleCustomer').value||'';
  if(!productName){ alert('Select product'); return; }

  // Get product price & stock
  db.collection('products').where('name','==',productName).get().then(snapshot=>{
    if(snapshot.empty){ alert('Product not found'); return; }
    snapshot.forEach(doc=>{
      const data=doc.data();
      if(data.stock<qty){ alert('Insufficient stock'); return; }
      const total=data.price*qty;
      // Save sale
      db.collection('sales').add({
        product:productName,
        qty,
        price:data.price,
        total,
        payment,
        customer,
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
      }).then(()=>{
        // Deduct stock
        db.collection('products').doc(doc.id).update({stock:firebase.firestore.FieldValue.increment(-qty)});
        loadProducts(); loadSales(); printSaleReceipt(productName,qty,data.price,total,payment,customer);
        alert('Sale recorded');
      });
    });
  });
}

// LOAD SALES TABLE
function loadSales(){
  db.collection('sales').orderBy('timestamp','desc').get().then(snapshot=>{
    const tbody=document.querySelector('#salesTable tbody'); tbody.innerHTML='';
    const salesData=[];
    const paymentData={};
    snapshot.forEach(doc=>{
      const data=doc.data();
      const tr=document.createElement('tr');
      const dateStr=data.timestamp?new Date(data.timestamp.seconds*1000).toLocaleString():'';
      tr.innerHTML=`<td>${dateStr}</td><td>${data.product}</td><td>${data.qty}</td><td>${data.price}</td><td>${data.total}</td><td>${data.payment}</td><td>${data.customer}</td>`;
      tbody.appendChild(tr);
      salesData.push(data.total);
      paymentData[data.payment]=(paymentData[data.payment]||0)+data.total;
    });
    drawSalesChart(salesData); drawPaymentChart(paymentData);
  });
}

// PRINT RECEIPT
function printSaleReceipt(name,qty,price,total,payment,customer){
  const iframe=document.getElementById('receiptFrame');
  const content=`<html><head><style>
  body{font-family:monospace; width:50mm;}
  h2{text-align:center;} p{margin:2px;}
  </style></head><body>
  <h2>URBAN FINDS by JNK</h2>
  <p>Product: ${name}</p>
  <p>Qty: ${qty}</p>
  <p>Price: ${price}</p>
  <p>Total: ${total}</p>
  <p>Payment: ${payment}</p>
  <p>Customer: ${customer}</p>
  <p>Thank you for your support!</p>
  </body></html>`;
  iframe.contentDocument.open(); iframe.contentDocument.write(content); iframe.contentDocument.close();
  iframe.contentWindow.focus(); iframe.contentWindow.print();
}

// EXPORT SALES
function exportSales(){/* implement CSV export */}

// ANALYTICS CHARTS
function drawSalesChart(salesData){
  const ctx=document.getElementById('salesChart').getContext('2d');
  new Chart(ctx,{type:'line',data:{labels:salesData.map((_,i)=>i+1),datasets:[{label:'Sales Total',data:salesData, borderColor:'green',fill:false}]}});
}
function drawPaymentChart(paymentData){
  const ctx=document.getElementById('paymentChart').getContext('2d');
  new Chart(ctx,{type:'pie',data:{labels:Object.keys(paymentData),datasets:[{data:Object.values(paymentData),backgroundColor:['#1abc9c','#3498db','#e74c3c','#9b59b6']}]}})
}
// INITIALIZATION
window.onload = function(){
  loadParcels();
  loadProducts();
  loadSales();
  initBarcodeScanner();
};

// BARCODE SCANNER (example integration)
function initBarcodeScanner(){
  // You can use any scanner library; here is a simple keypress listener
  let barcode = '';
  let interval;
  document.addEventListener('keypress', function(e){
    if(interval) clearTimeout(interval);
    if(e.key === 'Enter'){
      if(barcode.length>3){
        document.getElementById('parcelTracking').value = barcode;
        addParcel();
      }
      barcode = '';
      return;
    }
    barcode += e.key;
    interval = setTimeout(()=>{ barcode=''; },100);
  });
}

// HELPER FUNCTIONS
function editParcel(id){
  db.collection('parcels').doc(id).get().then(doc=>{
    const data=doc.data();
    document.getElementById('parcelName').value=data.name;
    document.getElementById('parcelBarangay').value=data.barangay;
    document.getElementById('parcelTracking').value=data.tracking;
    document.getElementById('parcelPrice').value=data.price;
    document.getElementById('parcelStatus').value=data.status;
    if(confirm('Update parcel now?')){ 
      db.collection('parcels').doc(id).update({
        name:data.name, barangay:data.barangay, tracking:data.tracking, price:data.price, status:data.status
      }).then(()=>{ loadParcels(); });
    }
  });
}
function deleteParcel(id){ if(confirm('Delete parcel?')) db.collection('parcels').doc(id).delete().then(()=>{ loadParcels(); }); }

// CSV EXPORT PLACEHOLDER (implement as needed)
function exportProducts(){/* generate CSV from products table */ }
function exportSales(){/* generate CSV from sales table */ }
function exportParcels(){/* generate CSV from parcels table */ }

</script>
</body>
</html>
