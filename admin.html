<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Admin Panel - JNK Express</title>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
<style>
body { font-family: sans-serif; background: #fff3f3; padding: 20px; max-width: 800px; margin: auto; }
h2 { color: #D7282F; }
input, select, button { width: 100%; padding: 12px; margin-top: 10px; font-size: 1em; border-radius: 6px; border: 1px solid #ccc; }
button { background-color: #D7282F; color: white; border: none; margin-bottom: 20px; cursor: pointer; }
.item { background: #fff; padding: 10px; margin: 10px 0; border-left: 5px solid #D7282F; border-radius: 4px; display: flex; justify-content: space-between; align-items: flex-start; }
.item-content { width: 100%; }
.delete-btn { background: #aaa; color: white; border: none; padding: 6px 10px; border-radius: 4px; cursor: pointer; margin-left: 10px; }
.pagination { display: flex; justify-content: center; gap: 10px; margin-top: 20px; }
.timeline { margin-top: 5px; padding-left: 10px; font-size: 0.95em; color: #333; }
.top-bar { display: flex; gap: 10px; flex-wrap: wrap; }
#receiptArea { display: none; }
table { width: 100%; border-collapse: collapse; margin-top: 10px; }
th, td { border: 1px solid #ccc; padding: 6px; text-align: left; }
th { background: #eee; }
</style>
</head>
<body>
<h2>JNK Admin Panel</h2>

<div id="loginSection">
<input type="text" id="username" placeholder="Username" />
<input type="password" id="password" placeholder="Password" />
<button onclick="login()">Login</button>
<p id="loginMessage" style="color:red;"></p>
</div>

<div id="adminSection" style="display:none;">
<button onclick="logout()">üö™ Logout</button>

<input type="text" id="trackNumber" placeholder="Tracking Number" />
<input type="text" id="parcelName" placeholder="Parcel Name" />
<input type="text" id="barangay" placeholder="Barangay" />
<input type="number" id="price" placeholder="Price (PHP)" />
<select id="trackStatus">
<option value="">Select Status</option>
<option>Package Received</option>
<option>In Transit</option>
<option>Arrived</option>
<option>For Pick-up</option>
</select>
<input type="text" id="trackLocation" placeholder="Location (e.g., Manila Hub)" />
<input type="date" id="estimatedDate" />
<button onclick="saveTracking()">Add / Update</button>
<button onclick="printAndSave()">üñ®Ô∏è Print Receipt</button>

<button onclick="startScanner()">üì∑ Scan</button>
<div id="scannerContainer" style="display:none">
  <div id="scanner" style="width:100%"></div>
  <button onclick="stopScanner()">‚ùå Cancel</button>
</div>

<div class="top-bar">
<input type="text" id="searchInput" placeholder="Search tracking number..." />
<button onclick="renderEntries()">üîç Search</button>
</div>

<div class="top-bar">
<input type="date" id="excelFrom" />
<input type="date" id="excelTo" />
<button onclick="exportExcelByDateRange()">üìä Export Excel by Date</button>
</div>

<div class="top-bar">
<input type="date" id="bulkFromDate" />
<input type="time" id="bulkFromTime" />
<input type="date" id="bulkToDate" />
<input type="time" id="bulkToTime" />
<select id="bulkStatus">
<option value="">Update Status to...</option>
<option>Package Received</option>
<option>In Transit</option>
<option>Arrived</option>
<option>For Pick-up</option>
</select>
<input type="text" id="bulkLocation" placeholder="Optional New Location" />
<button onclick="bulkUpdateByTimeRange()">Apply Bulk Update</button>
</div>

<h3>Backfill Missing Data</h3>
<button onclick="loadBackfill()">Load Missing Entries</button>
<button onclick="backfillAll()">Backfill All Missing Data</button>
<div id="backfillList"></div>

<h3>All Tracking Entries</h3>
<div id="entries"></div>
<div class="pagination">
<button onclick="prevPage()">Previous</button>
<button onclick="nextPage()">Next</button>
</div>
</div>

<div id="receiptArea">
<div id="receiptContent" style="font-family:monospace; font-size:10pt;"></div>
</div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyAnrNfuTSRAKUS2tAU4AUUrauw_QzszCjY",
  authDomain: "jnk-ordertracker.firebaseapp.com",
  projectId: "jnk-ordertracker",
  storageBucket: "jnk-ordertracker.appspot.com",
  messagingSenderId: "421193030070",
  appId: "1:421193030070:web:078e39980237bc41f64917"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

const USERNAME = "JNK";
const PASSWORD = "11223344$";
let allEntries = [];
let currentPage = 1;
const pageSize = 10;

function login() {
  const user = document.getElementById("username").value;
  const pass = document.getElementById("password").value;
  if (user === USERNAME && pass === PASSWORD) {
    document.getElementById("loginSection").style.display = "none";
    document.getElementById("adminSection").style.display = "block";
    loadAllEntries();
  } else { document.getElementById("loginMessage").innerText = "Invalid login."; }
}
function logout() { location.reload(); }

let scanner;
function startScanner() {
  document.getElementById("scannerContainer").style.display = "block";
  scanner = new Html5Qrcode("scanner");
  scanner.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 },
    (decodedText) => { document.getElementById("trackNumber").value = decodedText.trim(); stopScanner(); printAndSave(); },
    () => {}
  );
}
function stopScanner() {
  document.getElementById("scannerContainer").style.display = "none";
  if (scanner) scanner.stop().then(() => scanner.clear()).catch(() => {});
}

async function printAndSave() {
  const number = document.getElementById("trackNumber").value.trim().toUpperCase();
  const name = document.getElementById("parcelName").value.trim();
  const barangay = document.getElementById("barangay").value.trim();
  const price = document.getElementById("price").value.trim();
  const status = document.getElementById("trackStatus").value;
  const location = document.getElementById("trackLocation").value.trim();
  const estimatedDate = document.getElementById("estimatedDate").value;
  const now = firebase.firestore.Timestamp.now();

  if (!number || !name || !barangay || !price || !status) return alert("Complete all fields");

  const docRef = db.collection("tracking").doc(number);
  const docSnap = await docRef.get();
  let statusHistory = docSnap.exists ? docSnap.data().statusHistory || [] : [];
  statusHistory.push({ status, timestamp: now });

  await docRef.set({
    parcelName: name,
    barangay: barangay,
    location,
    price,
    estimatedDate,
    statusHistory,
    timestamp: now
  });

  ["trackNumber","parcelName","barangay","price","trackStatus","trackLocation","estimatedDate"].forEach(id => document.getElementById(id).value="");
  loadAllEntries();
}

function loadAllEntries() {
  db.collection("tracking").orderBy("timestamp","desc").onSnapshot(snapshot => {
    allEntries = snapshot.docs.map(doc => {
      const data = doc.data();
      return {
        id: doc.id,
        parcelName: data.parcelName || '',
        barangay: data.barangay || '',
        location: data.location || '',
        price: data.price || '',
        statusHistory: data.statusHistory || [],
        estimatedDate: data.estimatedDate || '',
        timestamp: data.timestamp?.toDate() || null
      };
    });
    renderEntries();
  });
}

function renderEntries() {
  const search = document.getElementById("searchInput").value.toUpperCase();
  const entriesDiv = document.getElementById("entries");
  entriesDiv.innerHTML = "";
  const filtered = allEntries.filter(e => e.id.includes(search));
  const start = (currentPage-1)*pageSize;
  const paginated = filtered.slice(start,start+pageSize);
  paginated.forEach(entry => {
    const timeline = entry.statusHistory.map(h => `${h.timestamp?.toDate().toLocaleString() || 'N/A'} - ${h.status}`).join("<br>");
    entriesDiv.innerHTML += `<div class='item'>
      <div class='item-content'>
      <strong>${entry.id}</strong><br>
      Name: ${entry.parcelName}<br>
      Barangay: ${entry.barangay}<br>
      Location: ${entry.location}<br>
      Price: ‚Ç±${entry.price}<br>
      Estimated Delivery: ${entry.estimatedDate}<br>
      <strong>Encoded:</strong> ${entry.timestamp ? entry.timestamp.toLocaleString() : 'N/A'}<br>
      Timeline:<div class='timeline'>${timeline}</div>
      </div>
      <button class='delete-btn' onclick="deleteEntry('${entry.id}')">Delete</button>
    </div>`;
  });
}

function nextPage(){const filtered=allEntries.filter(e=>e.id.includes(document.getElementById("searchInput").value.toUpperCase()));const totalPages=Math.ceil(filtered.length/pageSize);if(currentPage<totalPages)currentPage++;renderEntries();}
function prevPage(){if(currentPage>1)currentPage--;renderEntries();}

function exportExcelByDateRange() {
  const from = new Date(document.getElementById("excelFrom").value);
  const to = new Date(document.getElementById("excelTo").value); to.setHours(23,59,59,999);
  const filtered = allEntries.filter(entry=>entry.timestamp>=from && entry.timestamp<=to);
  if(filtered.length===0) return alert("No entries found in selected date range.");
  const data = filtered.map(e=>({
    TrackingNumber:e.id, ParcelName:e.parcelName, Barangay:e.barangay,
    Location:e.location, Price:e.price, EstimatedDelivery:e.estimatedDate,
    StatusTimeline:e.statusHistory.map(s=>`${s.timestamp?.toDate().toLocaleString()} - ${s.status}`).join(" | ")
  }));
  const ws = XLSX.utils.json_to_sheet(data);
  const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "Tracking Data");
  XLSX.writeFile(wb, `tracking_export_${filtered.length}_items_${Date.now()}.xlsx`);
}

async function deleteEntry(id) {
  const confirmPass=prompt("Enter admin password to delete:");
  if(confirmPass!==PASSWORD) return alert("‚ùå Incorrect password.");
  await db.collection("tracking").doc(id).delete();
  alert("Deleted.");
  loadAllEntries();
}

async function bulkUpdateByTimeRange() {
  const fromDateStr=document.getElementById("bulkFromDate").value;
  const fromTimeStr=document.getElementById("bulkFromTime").value||"00:00";
  const toDateStr=document.getElementById("bulkToDate").value;
  const toTimeStr=document.getElementById("bulkToTime").value||"23:59";
  const status=document.getElementById("bulkStatus").value;
  const location=document.getElementById("bulkLocation").value.trim();
  if(!fromDateStr||!toDateStr||!status) return alert("Fill all date/time and status fields.");
  const fromDateTime=new Date(`${fromDateStr}T${fromTimeStr}`);
  const toDateTime=new Date(`${toDateStr}T${toTimeStr}`);
  if(toDateTime<fromDateTime) return alert("TO date/time must be after FROM date/time.");
  const confirmPass=prompt("Enter admin password to apply bulk update:");
  if(confirmPass!==PASSWORD) return alert("‚ùå Incorrect password.");
  const fromTs=firebase.firestore.Timestamp.fromDate(fromDateTime);
  const toTs=firebase.firestore.Timestamp.fromDate(toDateTime);
  const snapshot=await db.collection("tracking").where("timestamp",">=",fromTs).where("timestamp","<=",toTs).get();
  if(snapshot.empty) return alert("No entries found in selected range.");
  const batch=db.batch();
  snapshot.docs.forEach(doc=>{
    const data=doc.data(); const history=data.statusHistory||[];
    history.push({status,timestamp:firebase.firestore.Timestamp.now()});
    batch.update(doc.ref,{location:location||data.location,estimatedDate:data.estimatedDate||'',statusHistory:history});
  });
  await batch.commit(); alert(`‚úÖ Bulk update applied to ${snapshot.size} entries.`); loadAllEntries();
}

/* --------- BACKFILL MISSING DATA --------- */
function loadBackfill() {
  const missing = allEntries.filter(e=>!e.parcelName || !e.barangay || !e.price);
  const div = document.getElementById("backfillList");
  if(missing.length===0){div.innerHTML="<p>No missing entries found.</p>"; return;}
  let html = `<table><tr><th>Tracking #</th><th>Parcel Name</th><th>Barangay</th><th>Price</th><th>Action</th></tr>`;
  missing.forEach(e=>{
    html+=`<tr id="row-${e.id}">
      <td>${e.id}</td>
      <td><input type="text" id="bf-name-${e.id}" value="${e.parcelName}"></td>
      <td><input type="text" id="bf-barangay-${e.id}" value="${e.barangay}"></td>
      <td><input type="number" id="bf-price-${e.id}" value="${e.price}"></td>
      <td><button onclick="saveBackfill('${e.id}')">Save</button></td>
    </tr>`;
  });
  html+="</table>";
  div.innerHTML=html;
}

async function saveBackfill(id) {
  const name=document.getElementById(`bf-name-${id}`).value.trim()||"-";
  const barangay=document.getElementById(`bf-barangay-${id}`).value.trim()||"-";
  const price=document.getElementById(`bf-price-${id}`).value.trim()||"0";
  await db.collection("tracking").doc(id).update({parcelName:name,barangay:barangay,price});
  alert(`‚úÖ Updated ${id}`);
  loadAllEntries(); loadBackfill();
}

async function backfillAll() {
  const confirmPass=prompt("Enter admin password to backfill all missing data:");
  if(confirmPass!==PASSWORD) return alert("‚ùå Incorrect password.");
  const missing = allEntries.filter(e=>!e.parcelName||!e.barangay||!e.price);
  const batch=db.batch();
  missing.forEach(e=>{
    const name=e.parcelName||"-";
    const barangay=e.barangay||"-";
    const price=e.price||"0";
    batch.update(db.collection("tracking").doc(e.id),{parcelName:name,barangay:barangay,price});
  });
  await batch.commit();
  alert(`‚úÖ Backfilled ${missing.length} entries`);
  loadAllEntries(); loadBackfill();
}
</script>
</body>
</html>
