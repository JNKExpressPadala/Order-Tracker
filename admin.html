<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Admin Panel - JNK Express</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

  <!-- XLSX (SheetJS) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <!-- QR Scanner -->
  <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>

  <!-- Charts -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <!-- Export Analytics to PDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

  <style>
    :root { --brand:#D7282F; }
    body { font-family: sans-serif; background: #fff3f3; padding: 20px; max-width: 1000px; margin: auto; }
    h2 { color: var(--brand); margin-bottom: 6px; }
    input, select, button {
      width: 100%; padding: 12px; margin-top: 10px;
      font-size: 1em; border-radius: 6px; border: 1px solid #ccc; background: #fff;
    }
    button { background-color: var(--brand); color: white; border: none; margin-bottom: 20px; cursor: pointer; }
    .btn-secondary { background:#666; }
    .btn-ghost { background:#fff; color:var(--brand); border:1px solid var(--brand); }
    .item {
      background: #fff; padding: 10px; margin: 10px 0;
      border-left: 5px solid var(--brand); border-radius: 4px;
      display: flex; justify-content: space-between; align-items: flex-start;
    }
    .item-content { width: 100%; }
    .delete-btn {
      background: #aaa; color: white; border: none;
      padding: 6px 10px; border-radius: 4px; cursor: pointer; margin-left: 10px;
    }
    .pagination { display: flex; justify-content: center; gap: 10px; margin-top: 20px; }
    .timeline { margin-top: 5px; padding-left: 10px; font-size: 0.95em; color: #333; }
    .top-bar { display: grid; grid-template-columns: repeat(12,1fr); gap: 10px; align-items: end; }
    .col-3 { grid-column: span 3; } .col-4 { grid-column: span 4; } .col-6 { grid-column: span 6; } .col-12{grid-column: span 12;}
    #receiptArea { display: none; }

    /* Tabs */
    .tabs { display:flex; gap:8px; margin:12px 0 18px; }
    .tab-btn { padding:10px 14px; border-radius:8px; border:1px solid var(--brand); background:#fff; color:var(--brand); cursor:pointer; }
    .tab-btn.active { background: var(--brand); color:#fff; }
    .tab-content { display:none; }
    .tab-content.active { display:block; }

    /* Analytics */
    .kpis { display:grid; grid-template-columns: repeat(4,1fr); gap:10px; margin:10px 0 20px; }
    .kpi { background:#fff; border-radius:10px; padding:14px; box-shadow:0 2px 10px rgba(0,0,0,.05); }
    .kpi h4 { margin:0 0 6px; color:#444; font-weight:600; }
    .kpi .big { font-size:1.4em; font-weight:700; }
    .grid-2 { display:grid; grid-template-columns:1fr 1fr; gap:14px; }
    .card { background:#fff; border-radius:12px; padding:14px; box-shadow:0 2px 12px rgba(0,0,0,.06); }
    .card h3 { margin:0 0 10px; color:#333; }
    canvas { width: 100% !important; height: 340px !important; }
    table { width:100%; border-collapse: collapse; background:#fff; border-radius:10px; overflow:hidden; }
    th, td { padding:10px; border-bottom:1px solid #eee; text-align:left; }
    th { background:#f8f8f8; }

    @media (max-width: 800px) {
      .kpis { grid-template-columns: repeat(2,1fr); }
      .grid-2 { grid-template-columns:1fr; }
      .top-bar { grid-template-columns: repeat(2,1fr); }
      .col-3,.col-4,.col-6,.col-12 { grid-column: span 2; }
    }
  </style>
</head>
<body>
  <h2>JNK Admin Panel</h2>

  <!-- Login -->
  <div id="loginSection">
    <input type="text" id="username" placeholder="Username" />
    <input type="password" id="password" placeholder="Password" />
    <button onclick="login()">Login</button>
    <p id="loginMessage" style="color:red;"></p>
  </div>

  <!-- Admin -->
  <div id="adminSection" style="display:none;">
    <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
      <button class="btn-secondary" onclick="logout()">üö™ Logout</button>
      <div class="tabs">
        <button id="tabManageBtn" class="tab-btn active" onclick="switchTab('manageTab')">Manage</button>
        <button id="tabAnalyticsBtn" class="tab-btn" onclick="switchTab('analyticsTab')">Analytics</button>
      </div>
    </div>

    <!-- Manage Tab -->
    <div id="manageTab" class="tab-content active">
      <input type="text" id="trackNumber" placeholder="Tracking Number" />
      <input type="text" id="parcelName" placeholder="Parcel Name" />
      <input type="text" id="barangay" placeholder="Barangay" />
      <input type="number" id="price" placeholder="Price (PHP)" />
      <select id="trackStatus">
        <option value="">Select Status</option>
        <option>Package Received</option>
        <option>In Transit</option>
        <option>Arrived</option>
        <option>For Pick-up</option>
      </select>
      <input type="text" id="trackLocation" placeholder="Location (e.g., Manila Hub)" />
      <input type="date" id="estimatedDate" />
      <div class="top-bar" style="margin-top:6px;">
        <button class="col-6" onclick="saveTracking()">Add / Update</button>
        <button class="col-6" onclick="printAndSave()">üñ®Ô∏è Print Receipt</button>
      </div>

      <button onclick="startScanner()">üì∑ Scan</button>
      <div id="scannerContainer" style="display:none">
        <div id="scanner" style="width:100%"></div>
        <button onclick="stopScanner()">‚ùå Cancel</button>
      </div>

      <div class="top-bar">
        <input class="col-9" type="text" id="searchInput" placeholder="Search tracking number..." />
        <button class="col-3" onclick="renderEntries()">üîç Search</button>
      </div>

      <div class="top-bar">
        <input class="col-3" type="date" id="excelFrom" />
        <input class="col-3" type="date" id="excelTo" />
        <button class="col-6" onclick="exportExcelByDateRange()">üìä Export Excel by Date (with totals)</button>
      </div>

      <div class="top-bar">
        <input class="col-3" type="date" id="bulkFromDate" />
        <input class="col-3" type="time" id="bulkFromTime" />
        <input class="col-3" type="date" id="bulkToDate" />
        <input class="col-3" type="time" id="bulkToTime" />
        <select class="col-6" id="bulkStatus">
          <option value="">Update Status to...</option>
          <option>Package Received</option>
          <option>In Transit</option>
          <option>Arrived</option>
          <option>For Pick-up</option>
        </select>
        <input class="col-6" type="text" id="bulkLocation" placeholder="Optional New Location" />
        <button class="col-12" onclick="bulkUpdateByTimeRange()">Apply Bulk Update</button>
      </div>

      <h3>All Tracking Entries</h3>
      <div id="entries"></div>
      <div class="pagination">
        <button onclick="prevPage()">Previous</button>
        <button onclick="nextPage()">Next</button>
      </div>
    </div>

    <!-- Analytics Tab -->
    <div id="analyticsTab" class="tab-content">
      <div class="card" style="margin-bottom:12px;">
        <h3>Filters</h3>
        <div class="top-bar">
          <input class="col-3" type="date" id="anFrom" />
          <input class="col-3" type="date" id="anTo" />
          <button class="col-3" onclick="refreshAnalytics()">Refresh Analytics</button>
          <div class="col-3" style="display:flex; gap:8px;">
            <button class="btn-ghost" onclick="exportAnalyticsPDF()">Export PDF</button>
            <button class="btn-ghost" onclick="exportAnalyticsExcel()">Export Excel</button>
          </div>
        </div>
      </div>

      <div id="analyticsArea">
        <div class="kpis">
          <div class="kpi"><h4>Total Parcels</h4><div id="kpiParcels" class="big">0</div></div>
          <div class="kpi"><h4>Total Revenue</h4><div id="kpiRevenue" class="big">‚Ç±0</div></div>
          <div class="kpi"><h4>Avg Price / Parcel</h4><div id="kpiAvgPrice" class="big">‚Ç±0</div></div>
          <div class="kpi"><h4>Top Earning Day</h4><div id="kpiTopDay" class="big">-</div></div>
        </div>

        <div class="grid-2">
          <div class="card">
            <h3>üì¶ Daily Parcel Volume</h3>
            <canvas id="chartDaily"></canvas>
          </div>
          <div class="card">
            <h3>üì¶ Monthly Parcel Volume</h3>
            <canvas id="chartMonthly"></canvas>
          </div>
        </div>

        <div class="grid-2" style="margin-top:14px;">
          <div class="card">
            <h3>üí∞ Daily Revenue</h3>
            <canvas id="chartRevenue"></canvas>
          </div>
          <div class="card">
            <h3>üìç Barangay Distribution</h3>
            <canvas id="chartBarangay"></canvas>
          </div>
        </div>

        <div class="grid-2" style="margin-top:14px;">
          <div class="card">
            <h3>üë• Repeat Customers</h3>
            <div id="repeatCustomers">0</div>
            <table id="tblTopSenders">
              <thead><tr><th>Sender (Parcel Name)</th><th>Parcels</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
          <div class="card">
            <h3>üî• Top Barangays</h3>
            <table id="tblTopBarangays">
              <thead><tr><th>Barangay</th><th>Parcels</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div><!-- /analyticsArea -->
    </div><!-- /analyticsTab -->

  </div><!-- /adminSection -->

  <!-- Hidden receipt area -->
  <div id="receiptArea">
    <div id="receiptContent" style="font-family:monospace; font-size:10pt;"></div>
  </div>

<script>
/* ==============================
   Firebase Setup
============================== */
const firebaseConfig = {
  apiKey: "AIzaSyAnrNfuTSRAKUS2tAU4AUUrauw_QzszCjY",
  authDomain: "jnk-ordertracker.firebaseapp.com",
  projectId: "jnk-ordertracker",
  storageBucket: "jnk-ordertracker.appspot.com",
  messagingSenderId: "421193030070",
  appId: "1:421193030070:web:078e39980237bc41f64917"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

/* ==============================
   Globals / Auth
============================== */
const USERNAME = "JNK";
const PASSWORD = "11223344$";
let allEntries = [];
let currentPage = 1;
const pageSize = 10;

/* ==============================
   Tabs
============================== */
function switchTab(tabId) {
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
  if (tabId === 'manageTab') {
    document.getElementById('tabManageBtn').classList.add('active');
  } else {
    document.getElementById('tabAnalyticsBtn').classList.add('active');
    // Initialize default analytics dates on first open if empty
    if (!document.getElementById('anFrom').value || !document.getElementById('anTo').value) {
      const today = new Date();
      const from = new Date(today); from.setDate(today.getDate() - 29);
      document.getElementById('anFrom').value = toYMD(from);
      document.getElementById('anTo').value = toYMD(today);
    }
    refreshAnalytics();
  }
  document.getElementById(tabId).classList.add('active');
}

/* ==============================
   Auth
============================== */
function login() {
  const user = document.getElementById("username").value;
  const pass = document.getElementById("password").value;
  if (user === USERNAME && pass === PASSWORD) {
    document.getElementById("loginSection").style.display = "none";
    document.getElementById("adminSection").style.display = "block";
    loadAllEntries();
  } else {
    document.getElementById("loginMessage").innerText = "Invalid login.";
  }
}
function logout() {
  document.getElementById("loginSection").style.display = "block";
  document.getElementById("adminSection").style.display = "none";
  document.getElementById("username").value = "";
  document.getElementById("password").value = "";
}

/* ==============================
   QR Scanner
============================== */
let scanner;
function startScanner() {
  document.getElementById("scannerContainer").style.display = "block";
  scanner = new Html5Qrcode("scanner");
  scanner.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 },
    (decodedText) => {
      document.getElementById("trackNumber").value = decodedText.trim();
      stopScanner();
      printAndSave();
    },
    () => {}
  );
}
function stopScanner() {
  document.getElementById("scannerContainer").style.display = "none";
  if (scanner) scanner.stop().then(() => scanner.clear()).catch(() => {});
}

/* ==============================
   Create / Update + Print
============================== */
async function saveTracking() {
  const number = document.getElementById("trackNumber").value.trim().toUpperCase();
  const name = document.getElementById("parcelName").value.trim();
  const barangay = document.getElementById("barangay").value.trim();
  const price = document.getElementById("price").value.trim();
  const status = document.getElementById("trackStatus").value;
  const location = document.getElementById("trackLocation").value.trim();
  const estimatedDate = document.getElementById("estimatedDate").value;
  const now = firebase.firestore.Timestamp.now();

  if (!number || !name || !barangay || !price || !status) return alert("Complete all fields");

  const docRef = db.collection("tracking").doc(number);
  const docSnap = await docRef.get();
  let statusHistory = docSnap.exists ? docSnap.data().statusHistory || [] : [];
  statusHistory.push({ status, timestamp: now });

  await docRef.set({
    parcelName: name,
    barangay: barangay,
    location,
    price,
    estimatedDate,
    statusHistory,
    timestamp: now
  }, { merge: true });

  ["trackNumber","parcelName","barangay","price","trackStatus","trackLocation","estimatedDate"]
    .forEach(id => document.getElementById(id).value = "");

  loadAllEntries();
}

async function printAndSave() {
  const number = document.getElementById("trackNumber").value.trim().toUpperCase();
  const name = document.getElementById("parcelName").value.trim();
  const barangay = document.getElementById("barangay").value.trim();
  const price = document.getElementById("price").value.trim();
  const status = document.getElementById("trackStatus").value;
  const location = document.getElementById("trackLocation").value.trim();
  const estimatedDate = document.getElementById("estimatedDate").value;
  const now = firebase.firestore.Timestamp.now();

  if (!number || !name || !barangay || !price || !status) return alert("Complete all fields");

  const docRef = db.collection("tracking").doc(number);
  const docSnap = await docRef.get();
  let statusHistory = docSnap.exists ? docSnap.data().statusHistory || [] : [];
  statusHistory.push({ status, timestamp: now });

  await docRef.set({
    parcelName: name,
    barangay: barangay,
    location,
    price,
    estimatedDate,
    statusHistory,
    timestamp: now
  }, { merge: true });

  const logoUrl = "logo.jpg";
  const content = `
    <div style="width: 48mm; height: 78mm; padding: 1mm; font-size: 10pt; font-family: monospace; text-align: center;">
      <img src="${logoUrl}" style="width: 30mm; margin-bottom: 2mm;" /><br>
      <strong style="font-size: 11pt;">JNK Express Padala</strong><br><br>
      <strong>${name}</strong><br>
      Brgy: ${barangay}<br>
      Price: ‚Ç±${price}<br>
      Tracking #: ${number}<br>
      <small>${new Date().toLocaleString()}</small><br><br>
      <em>Salamat sa tiwala KA-JNK!!</em>
    </div>`;

  const printWin = window.open('', '_blank', 'width=200,height=200');
  printWin.document.write(`
    <html>
      <head>
        <title>Print</title>
        <style>
          @page { size: 50mm 80mm portrait; margin: 0; }
          body { margin: 0; width: 50mm; height: 80mm; }
        </style>
      </head>
      <body onload="window.print(); window.close();">${content}</body>
    </html>`);
  printWin.document.close();

  ["trackNumber","parcelName","barangay","price","trackStatus","trackLocation","estimatedDate"]
    .forEach(id => document.getElementById(id).value = "");

  loadAllEntries();
}

/* ==============================
   Load & Render Entries
============================== */
function loadAllEntries() {
  db.collection("tracking").orderBy("timestamp", "desc").onSnapshot(snapshot => {
    allEntries = snapshot.docs.map(doc => {
      const data = doc.data();
      return {
        id: doc.id,
        parcelName: data.parcelName || '-',
        barangay: data.barangay || '-',
        location: data.location || '-',
        price: data.price || '-',
        statusHistory: data.statusHistory || [],
        estimatedDate: data.estimatedDate || '-',
        timestamp: data.timestamp?.toDate() || null,
      };
    });
    renderEntries();
  });
}

function renderEntries() {
  const search = document.getElementById("searchInput").value.toUpperCase();
  const entriesDiv = document.getElementById("entries");
  entriesDiv.innerHTML = "";
  const filtered = allEntries.filter(e => e.id.includes(search));
  const start = (currentPage - 1) * pageSize;
  const paginated = filtered.slice(start, start + pageSize);
  paginated.forEach(entry => {
    const timeline = entry.statusHistory.map(h => {
      const date = h.timestamp?.toDate().toLocaleString() || 'N/A';
      return `- [${date}] ${h.status}`;
    }).join("<br>");
    entriesDiv.innerHTML += `
      <div class='item'>
        <div class='item-content'>
          <strong>${entry.id}</strong><br>
          Name: ${entry.parcelName}<br>
          Barangay: ${entry.barangay}<br>
          Location: ${entry.location}<br>
          Price: ‚Ç±${entry.price}<br>
          Estimated Delivery: ${entry.estimatedDate}<br>
          <strong>Encoded:</strong> ${entry.timestamp ? entry.timestamp.toLocaleString() : 'N/A'}<br>
          Timeline:<div class='timeline'>${timeline}</div>
        </div>
        <button class='delete-btn' onclick="deleteEntry('${entry.id}')">Delete</button>
      </div>`;
  });
}

function nextPage() {
  const filtered = allEntries.filter(e => e.id.includes(document.getElementById("searchInput").value.toUpperCase()));
  const totalPages = Math.ceil(filtered.length / pageSize);
  if (currentPage < totalPages) currentPage++;
  renderEntries();
}
function prevPage() {
  if (currentPage > 1) currentPage--;
  renderEntries();
}

/* ==============================
   Export Excel (Manage) ‚Äî ONLY 4 columns + totals row
============================== */
function exportExcelByDateRange() {
  const fromInput = document.getElementById("excelFrom").value;
  const toInput = document.getElementById("excelTo").value;
  if (!fromInput || !toInput) return alert("Select FROM and TO dates.");
  const from = new Date(fromInput);
  const to = new Date(toInput);
  to.setHours(23, 59, 59, 999);

  const filtered = allEntries.filter(entry => entry.timestamp && entry.timestamp >= from && entry.timestamp <= to);
  if (filtered.length === 0) return alert("No entries found in selected date range.");

  // Build AOA (array-of-arrays) to inject totals at the bottom
  const header = ["TrackingNumber","ParcelName","Barangay","Price"];
  const rows = filtered.map(e => [
    e.id,
    e.parcelName || '-',
    e.barangay || '-',
    toNumber(e.price)
  ]);
  const totalPrice = rows.reduce((sum, r) => sum + (Number(r[3]) || 0), 0);

  const aoa = [header, ...rows, [], ["TOTAL ENTRIES", filtered.length, "", ""], ["TOTAL PRICE", "", "", totalPrice]];
  const ws = XLSX.utils.aoa_to_sheet(aoa);
  // Format currency column (Price) if supported by viewer
  const priceCol = "D";
  for (let i = 2; i <= rows.length + 3; i++) {
    const cell = ws[priceCol + i];
    if (cell && typeof cell.v === "number") cell.z = '"‚Ç±"#,##0.00';
  }
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Tracking Data");
  XLSX.writeFile(wb, `tracking_export_${filtered.length}_items_${Date.now()}.xlsx`);
}

/* ==============================
   Delete & Bulk Update
============================== */
async function deleteEntry(id) {
  const confirmPass = prompt("Enter admin password to delete:");
  if (confirmPass !== PASSWORD) return alert("‚ùå Incorrect password.");
  await db.collection("tracking").doc(id).delete();
  alert("Deleted.");
  loadAllEntries();
}

async function bulkUpdateByTimeRange() {
  const fromDateStr = document.getElementById("bulkFromDate").value;
  const fromTimeStr = document.getElementById("bulkFromTime").value || "00:00";
  const toDateStr = document.getElementById("bulkToDate").value;
  const toTimeStr = document.getElementById("bulkToTime").value || "23:59";
  const status = document.getElementById("bulkStatus").value;
  const location = document.getElementById("bulkLocation").value.trim();

  if (!fromDateStr || !toDateStr || !status) return alert("Fill all date/time and status fields.");
  const fromDateTime = new Date(`${fromDateStr}T${fromTimeStr}`);
  const toDateTime = new Date(`${toDateStr}T${toTimeStr}`);
  if (toDateTime < fromDateTime) return alert("TO date/time must be after FROM date/time.");

  const confirmPass = prompt("Enter admin password to apply bulk update:");
  if (confirmPass !== PASSWORD) return alert("‚ùå Incorrect password.");

  const fromTs = firebase.firestore.Timestamp.fromDate(fromDateTime);
  const toTs = firebase.firestore.Timestamp.fromDate(toDateTime);

  const snapshot = await db.collection("tracking")
    .where("timestamp", ">=", fromTs)
    .where("timestamp", "<=", toTs)
    .get();

  if (snapshot.empty) return alert("No entries found in selected range.");

  const batch = db.batch();
  snapshot.docs.forEach(doc => {
    const data = doc.data();
    const history = data.statusHistory || [];
    history.push({ status, timestamp: firebase.firestore.Timestamp.now() });
    batch.update(doc.ref, {
      location: location || data.location,
      estimatedDate: data.estimatedDate || '',
      statusHistory: history
    });
  });

  await batch.commit();
  alert(`‚úÖ Bulk update applied to ${snapshot.size} entries.`);
  loadAllEntries();
}

/* ==============================
   Analytics
============================== */
let chartDaily, chartMonthly, chartRevenue, chartBarangay;

function refreshAnalytics() {
  const fromStr = document.getElementById('anFrom').value;
  const toStr = document.getElementById('anTo').value;
  if (!fromStr || !toStr) return alert("Select analytics FROM and TO dates.");
  const from = new Date(fromStr);
  const to = new Date(toStr); to.setHours(23,59,59,999);

  const data = allEntries.filter(e => e.timestamp && e.timestamp >= from && e.timestamp <= to);

  // KPIs
  const totalParcels = data.length;
  const totalRevenue = data.reduce((s, e) => s + toNumber(e.price), 0);
  const avgPrice = totalParcels ? totalRevenue / totalParcels : 0;

  // Daily counts & revenue
  const byDayCounts = groupByKey(data, e => toYMD(e.timestamp), () => 0, (acc)=>acc+1);
  const byDayRevenue = groupByKey(data, e => toYMD(e.timestamp), () => 0, (acc, e)=>acc + toNumber(e.price));

  // Top earning day
  let topDay = "-";
  if (Object.keys(byDayRevenue).length) {
    const top = Object.entries(byDayRevenue).sort((a,b)=>b[1]-a[1])[0];
    topDay = `${top[0]} (‚Ç±${formatNumber(top[1])})`;
  }

  // Monthly counts
  const byMonthCounts = groupByKey(data, e => ymKey(e.timestamp), () => 0, (acc)=>acc+1);

  // Barangay distribution
  const barangayCounts = groupByKey(data, e => (e.barangay || '-').trim() || '-', () => 0, (acc)=>acc+1);

  // Repeat customers + top senders
  const bySenderCounts = groupByKey(data, e => (e.parcelName || '-').trim() || '-', () => 0, (acc)=>acc+1);
  const repeatCount = Object.values(bySenderCounts).filter(v => v > 1).length;
  const topSenders = Object.entries(bySenderCounts).sort((a,b)=>b[1]-a[1]).slice(0,5);
  const topBarangays = Object.entries(barangayCounts).sort((a,b)=>b[1]-a[1]).slice(0,5);

  // Update KPIs
  document.getElementById("kpiParcels").innerText = formatNumber(totalParcels);
  document.getElementById("kpiRevenue").innerText = `‚Ç±${formatNumber(totalRevenue)}`;
  document.getElementById("kpiAvgPrice").innerText = `‚Ç±${formatNumber(avgPrice)}`;
  document.getElementById("kpiTopDay").innerText = topDay;
  document.getElementById("repeatCustomers").innerText = repeatCount;

  // Tables
  fillTable("tblTopSenders", topSenders);
  fillTable("tblTopBarangays", topBarangays);

  // Charts
  const dayLabels = sortDateKeys(Object.keys(byDayCounts));
  const dayData = dayLabels.map(k => byDayCounts[k]);
  const revData = dayLabels.map(k => byDayRevenue[k] || 0);

  const monthLabels = sortMonthKeys(Object.keys(byMonthCounts));
  const monthData = monthLabels.map(k => byMonthCounts[k]);

  const barangayLabels = Object.keys(barangayCounts);
  const barangayData = barangayLabels.map(k => barangayCounts[k]);

  drawLineChart('chartDaily', 'Parcels per Day', dayLabels, dayData, c => chartDaily = c);
  drawBarChart('chartMonthly', 'Parcels per Month', monthLabels, monthData, c => chartMonthly = c);
  drawBarChart('chartRevenue', 'Revenue per Day (PHP)', dayLabels, revData, c => chartRevenue = c);
  drawPieChart('chartBarangay', 'Barangay Distribution', barangayLabels, barangayData, c => chartBarangay = c);
}

function exportAnalyticsPDF() {
  const el = document.getElementById('analyticsArea');
  const opt = {
    margin:       10,
    filename:     `analytics_${Date.now()}.pdf`,
    image:        { type: 'jpeg', quality: 0.95 },
    html2canvas:  { scale: 2, useCORS: true },
    jsPDF:        { unit: 'mm', format: 'a4', orientation: 'portrait' }
  };
  html2pdf().from(el).set(opt).save();
}

function exportAnalyticsExcel() {
  // Build a simple workbook with KPIs and top lists
  const kpiSheet = [
    ["Metric","Value"],
    ["Total Parcels", document.getElementById("kpiParcels").innerText],
    ["Total Revenue", document.getElementById("kpiRevenue").innerText],
    ["Average Price / Parcel", document.getElementById("kpiAvgPrice").innerText],
    ["Top Earning Day", document.getElementById("kpiTopDay").innerText],
  ];
  const ws1 = XLSX.utils.aoa_to_sheet(kpiSheet);

  const topSendersRows = [["Sender","Parcels"]];
  document.querySelectorAll("#tblTopSenders tbody tr").forEach(tr=>{
    const tds = tr.querySelectorAll("td");
    topSendersRows.push([tds[0].innerText, Number(tds[1].innerText)]);
  });
  const ws2 = XLSX.utils.aoa_to_sheet(topSendersRows);

  const topBarangayRows = [["Barangay","Parcels"]];
  document.querySelectorAll("#tblTopBarangays tbody tr").forEach(tr=>{
    const tds = tr.querySelectorAll("td");
    topBarangayRows.push([tds[0].innerText, Number(tds[1].innerText)]);
  });
  const ws3 = XLSX.utils.aoa_to_sheet(topBarangayRows);

  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws1, "KPIs");
  XLSX.utils.book_append_sheet(wb, ws2, "Top Senders");
  XLSX.utils.book_append_sheet(wb, ws3, "Top Barangays");
  XLSX.writeFile(wb, `analytics_${Date.now()}.xlsx`);
}

/* ==============================
   Chart Helpers
============================== */
function drawLineChart(id, label, labels, data, storeCb) {
  if (window[id]) { window[id].destroy(); }
  const ctx = document.getElementById(id).getContext('2d');
  const c = new Chart(ctx, {
    type: 'line',
    data: { labels, datasets: [{ label, data, tension: .25, fill: false }] },
    options: { responsive:true, maintainAspectRatio:false, scales:{ y:{ beginAtZero:true } } }
  });
  window[id] = c; storeCb(c);
}
function drawBarChart(id, label, labels, data, storeCb) {
  if (window[id]) { window[id].destroy(); }
  const ctx = document.getElementById(id).getContext('2d');
  const c = new Chart(ctx, {
    type: 'bar',
    data: { labels, datasets: [{ label, data }] },
    options: { responsive:true, maintainAspectRatio:false, scales:{ y:{ beginAtZero:true } } }
  });
  window[id] = c; storeCb(c);
}
function drawPieChart(id, label, labels, data, storeCb) {
  if (window[id]) { window[id].destroy(); }
  const ctx = document.getElementById(id).getContext('2d');
  const c = new Chart(ctx, {
    type: 'pie',
    data: { labels, datasets: [{ label, data }] },
    options: { responsive:true, maintainAspectRatio:false }
  });
  window[id] = c; storeCb(c);
}

/* ==============================
   Utility
============================== */
function toYMD(d) {
  const y = d.getFullYear();
  const m = String(d.getMonth()+1).padStart(2,'0');
  const day = String(d.getDate()).padStart(2,'0');
  return `${y}-${m}-${day}`;
}
function ymKey(d) {
  const y = d.getFullYear();
  const m = String(d.getMonth()+1).padStart(2,'0');
  return `${y}-${m}`;
}
function groupByKey(arr, keyFn, seedFn, reduceFn) {
  const map = {};
  arr.forEach(item => {
    const k = keyFn(item);
    if (!(k in map)) map[k] = seedFn(item);
    map[k] = reduceFn(map[k], item);
  });
  return map;
}
function sortDateKeys(keys) {
  return keys.sort((a,b)=> new Date(a) - new Date(b));
}
function sortMonthKeys(keys) {
  return keys.sort((a,b)=> {
    const [ya,ma] = a.split('-').map(Number);
    const [yb,mb] = b.split('-').map(Number);
    if (ya!==yb) return ya-yb;
    return ma-mb;
  });
}
function formatNumber(n) {
  return Math.round((Number(n)||0)*100)/100
    .toLocaleString(undefined, {minimumFractionDigits:0, maximumFractionDigits:2});
}
function toNumber(v) {
  if (typeof v === 'number') return v;
  if (!v) return 0;
  const cleaned = String(v).replace(/[^\d.-]/g,'');
  const n = parseFloat(cleaned);
  return isNaN(n) ? 0 : n;
}
function fillTable(tableId, rows) {
  const tbody = document.querySelector(`#${tableId} tbody`);
  tbody.innerHTML = "";
  rows.forEach(([name, count])=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${escapeHtml(name)}</td><td>${count}</td>`;
    tbody.appendChild(tr);
  });
}
function escapeHtml(s) {
  return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m]));
}
</script>
</body>
</html>
