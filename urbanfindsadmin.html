<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Admin Panel - JNK Express / URBAN FINDS</title>

<!-- CSS -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<style>
body { font-family: Arial, sans-serif; background: #f4f4f4; margin:0; padding:0; }
header { background: #2c3e50; color:#fff; padding: 10px 20px; font-size: 18px; font-weight:700; }
nav { background: #34495e; display:flex; }
nav button { flex:1; padding:10px; border:none; background:#34495e; color:#fff; cursor:pointer; font-weight:700; }
nav button.active { background:#16a085; }
section { padding: 20px; display:none; }
.item { background:#fff; padding:10px; margin-bottom:10px; display:flex; justify-content:space-between; align-items:center; border-radius:5px; box-shadow:0 1px 3px rgba(0,0,0,0.1); }
.muted { color:#666; font-size:12px; }
.small { font-size:11px; }
.red-stock { color:red; font-weight:700; }
.card { background:#fff; padding:15px; border-radius:5px; box-shadow:0 1px 3px rgba(0,0,0,0.1); margin-bottom:10px; }
input, select { padding:5px; margin:5px 0; width:100%; box-sizing:border-box; }
button { padding:5px 10px; cursor:pointer; border:none; border-radius:3px; background:#16a085; color:#fff; }
button:hover { background:#1abc9c; }
#scannerContainer { width:300px; height:300px; display:none; margin-bottom:10px; }
</style>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- XLSX for Excel export -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<!-- html5-qrcode for barcode scanning -->
<script src="https://unpkg.com/html5-qrcode/minified/html5-qrcode.min.js"></script>

<!-- jsPDF + html2canvas for PDF export -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

<script>
// ========================== Firebase Config ==========================
const firebaseConfig = {
  apiKey: "YOUR_API_KEY",
  authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
  projectId: "YOUR_PROJECT_ID",
  storageBucket: "YOUR_PROJECT_ID.appspot.com",
  messagingSenderId: "YOUR_SENDER_ID",
  appId: "YOUR_APP_ID"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

// ========================== Admin Password ==========================
const PASSWORD = "YOUR_ADMIN_PASSWORD";

// ========================== Global Variables ==========================
let currentPage = 1, pageSize = 20;
let allEntries = [];
let saleScanner, chartTopProducts, chartCategory, chartPayment;
</script>
</head>
<body>
<header>JNK Express / URBAN FINDS - Admin Panel</header>
<nav>
  <button onclick="showSection('trackingSection')" class="active">Parcel Tracking</button>
  <button onclick="showSection('productsSection')">Products</button>
  <button onclick="showSection('salesSection')">JNK Products Sales</button>
  <button onclick="showSection('analyticsSection')">Analytics</button>
</nav>
<!-- ========================== PRODUCTS TAB ========================== -->
<section id="productsSection">
  <h2>Inventory Manager - Products</h2>
  <div class="card">
    <h3>Add / Update Product</h3>
    <input type="text" id="prodBarcode" placeholder="Barcode" />
    <input type="text" id="prodName" placeholder="Product Name" />
    <input type="number" id="prodCost" placeholder="Cost Price" />
    <input type="number" id="prodPrice" placeholder="Selling Price" />
    <input type="number" id="prodStock" placeholder="Stock Quantity" />
    <textarea id="prodNotes" placeholder="Notes (optional)"></textarea>
    <button onclick="saveProduct()">Save Product</button>
    <button onclick="exportProductsExcel()">Export Excel</button>
  </div>

  <div id="productList">Loading...</div>
</section>

<script>
// ========================== Products Tab ==========================
async function saveProduct() {
  const barcode = (document.getElementById('prodBarcode').value || '').trim();
  const name = (document.getElementById('prodName').value || '').trim();
  const cost = Number(document.getElementById('prodCost').value) || 0;
  const price = Number(document.getElementById('prodPrice').value) || 0;
  const stock = Number(document.getElementById('prodStock').value) || 0;
  const notes = (document.getElementById('prodNotes').value || '').trim();
  if(!barcode || !name) return alert('Barcode and name required.');

  const docRef = db.collection('products').doc(barcode);
  const docSnap = await docRef.get();

  if(docSnap.exists){
    // Increment stock if exists
    const oldStock = Number(docSnap.data().stock) || 0;
    await docRef.update({
      name, cost, price, stock: oldStock + stock, notes
    });
  } else {
    await docRef.set({ name, cost, price, stock, notes, createdAt: firebase.firestore.Timestamp.now() });
  }

  // Clear inputs
  ['prodBarcode','prodName','prodCost','prodPrice','prodStock','prodNotes']
    .forEach(id => document.getElementById(id).value='');

  loadProducts();
  alert('Product saved / stock updated.');
}

async function loadProducts(){
  const list = document.getElementById('productList');
  list.innerHTML = 'Loading...';
  const snap = await db.collection('products').orderBy('createdAt','desc').get();
  if(snap.empty){ list.innerHTML = '<div class="card">No products</div>'; return; }

  list.innerHTML = '';
  snap.docs.forEach(doc => {
    const d = doc.data();
    const el = document.createElement('div');
    el.className = 'item';
    el.innerHTML = `
      <div>
        <div style="font-weight:700">${d.name} (${doc.id})</div>
        <div class="muted small">
          Cost: ₱${d.cost} | Selling: ₱${d.price} | Stock: <span class="${d.stock<5?'red-stock':''}">${d.stock}</span>
        </div>
        <div class="muted small">${d.notes || ''}</div>
      </div>
      <div>
        <button onclick="editProduct('${doc.id}')">Edit</button>
        <button onclick="deleteProduct('${doc.id}')">Delete</button>
      </div>`;
    list.appendChild(el);
  });
}

async function editProduct(id){
  const doc = await db.collection('products').doc(id).get();
  if(!doc.exists) return alert('Product not found.');
  const d = doc.data();
  document.getElementById('prodBarcode').value = id;
  document.getElementById('prodName').value = d.name || '';
  document.getElementById('prodCost').value = d.cost || '';
  document.getElementById('prodPrice').value = d.price || '';
  document.getElementById('prodStock').value = d.stock || '';
  document.getElementById('prodNotes').value = d.notes || '';
  window.scrollTo({ top: 0, behavior: 'smooth' });
}

async function deleteProduct(id){
  const confirmPass = prompt("Enter admin password to delete product:");
  if(confirmPass !== PASSWORD) return alert('Incorrect password.');
  await db.collection('products').doc(id).delete();
  loadProducts();
  alert('Deleted product.');
}

// Export Products
async function exportProductsExcel(){
  const snap = await db.collection('products').get();
  const aoa = [["Barcode","Name","Cost","Selling Price","Stock","Notes","CreatedAt"]];
  snap.docs.forEach(d=>{
    const x=d.data();
    aoa.push([d.id, x.name||'', x.cost||0, x.price||0, x.stock||0, x.notes||'', x.createdAt?.toDate ? x.createdAt.toDate().toLocaleString():'']);
  });
  const ws = XLSX.utils.aoa_to_sheet(aoa);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Products");
  XLSX.writeFile(wb, `products_${Date.now()}.xlsx`);
}

// Initial load
loadProducts();
</script>
<!-- ========================== SALES TAB ========================== -->
<section id="salesSection">
  <h2>JNK Products Sales</h2>

  <div class="card">
    <h3>Record Sale</h3>
    <input type="text" id="saleBarcode" placeholder="Scan Barcode or enter" />
    <input type="number" id="saleQty" placeholder="Quantity" value="1" />
    <select id="salePayment">
      <option value="Cash">Cash</option>
      <option value="Gcash">Gcash</option>
      <option value="Maya">Maya</option>
    </select>
    <input type="text" id="saleCustomer" placeholder="Customer Name" />
    <textarea id="saleNote" placeholder="Note (optional)"></textarea>
    <button onclick="recordSale()">Record Sale & Print</button>
    <button onclick="exportSalesExcel()">Export Sales Excel</button>
    <div id="scannerContainer" style="display:none;"></div>
    <button onclick="startSaleScanner()">Start Scanner</button>
  </div>

  <h3>Recent Sales</h3>
  <div id="salesList">Loading...</div>

  <h3>Sales Analytics</h3>
  <div class="card">
    <div>Total Revenue: ₱<span id="sKpiRevenue">0</span></div>
    <div>Total Cost: ₱<span id="sKpiCost">0</span></div>
    <div>Total Gain: ₱<span id="sKpiGain">0</span></div>
    <div>Remaining Stock: <span id="sKpiStock">0</span></div>
  </div>
  <canvas id="chartTopSelling" height="150"></canvas>
  <canvas id="chartPaymentMethod" height="150"></canvas>
</section>

<script>
// ========================== Sales Tab ==========================
let saleScanner;
let chartTopSelling, chartPaymentMethod;

async function recordSale(){
  const barcode = (document.getElementById('saleBarcode').value || '').trim();
  const qty = Number(document.getElementById('saleQty').value) || 1;
  const customer = (document.getElementById('saleCustomer').value || '').trim();
  const payment = document.getElementById('salePayment').value;
  const note = (document.getElementById('saleNote').value || '').trim();
  if(!barcode || qty<=0) return alert('Barcode and positive quantity required.');

  const prodRef = db.collection('products').doc(barcode);
  const prodSnap = await prodRef.get();
  if(!prodSnap.exists) return alert('Product not found.');
  const prod = prodSnap.data();

  const revenue = prod.price*qty;
  const cost = prod.cost*qty;
  const gain = revenue - cost;

  // record sale
  const sale = { productId: barcode, productName: prod.name, qty, payment, customer, revenue, cost, gain, note, timestamp: firebase.firestore.Timestamp.now() };
  await db.collection('sales').add(sale);

  // decrement stock
  const newStock = (prod.stock || 0) - qty;
  await prodRef.update({ stock: Math.max(0, newStock) });

  // print receipt (50mm width, variable height)
  const receiptWin = window.open('', '_blank');
  receiptWin.document.write(`<pre style="font-family:monospace;text-align:center">
URBAN FINDS by JNK
----------------------------
Product: ${prod.name}
Barcode: ${barcode}
Qty: ${qty}
Price: ₱${prod.price}
Total Revenue: ₱${revenue}
Cost: ₱${cost}
Gain: ₱${gain}
Customer: ${customer}
${note ? 'Note: '+note : ''}
----------------------------
Thank you for your purchase
</pre>`);
  receiptWin.print();
  receiptWin.close();

  // reset fields
  document.getElementById('saleBarcode').value = '';
  document.getElementById('saleQty').value = 1;
  document.getElementById('saleCustomer').value = '';
  document.getElementById('saleNote').value = '';

  loadProducts();
  loadSales();
  loadSalesAnalytics();
  alert('Sale recorded and printed.');
}

async function loadSales(){
  const list = document.getElementById('salesList');
  list.innerHTML = 'Loading...';
  const snap = await db.collection('sales').orderBy('timestamp','desc').limit(50).get();
  if(snap.empty){ list.innerHTML = '<div class="card">No recent sales</div>'; return; }

  list.innerHTML = '';
  snap.docs.forEach(doc => {
    const d = doc.data();
    const el = document.createElement('div');
    el.className = 'item';
    el.innerHTML = `
      <div>
        <div style="font-weight:700">${d.productName} (${d.productId})</div>
        <div class="muted small">
          Qty: ${d.qty} | Payment: ${d.payment} | Revenue: ₱${d.revenue} | Cost: ₱${d.cost} | Gain: ₱${d.gain}
        </div>
        <div class="muted small">${d.customer || ''} ${d.note ? '• '+d.note : ''}</div>
        <div class="muted small">${d.timestamp?.toDate ? d.timestamp.toDate().toLocaleString() : ''}</div>
      </div>`;
    list.appendChild(el);
  });
}

// Sale Scanner
function startSaleScanner(){
  if(!saleScanner) saleScanner = new Html5Qrcode("scannerContainer");
  document.getElementById("scannerContainer").style.display = "block";
  saleScanner.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 },
    decodedText => { document.getElementById('saleBarcode').value = decodedText.trim(); stopSaleScanner(); },
    ()=>{}
  );
}
function stopSaleScanner(){
  document.getElementById("scannerContainer").style.display = "none";
  if(saleScanner) saleScanner.stop().then(()=>saleScanner.clear()).catch(()=>{});
}

// Sales Analytics
async function loadSalesAnalytics(){
  const snapSales = await db.collection('sales').get();
  const snapProducts = await db.collection('products').get();
  const sales = snapSales.docs.map(d=>d.data());
  const products = snapProducts.docs.map(d=>d.data());

  const totalRevenue = sales.reduce((s,r)=>s+(r.revenue||0),0);
  const totalCost = sales.reduce((s,r)=>s+(r.cost||0),0);
  const totalGain = totalRevenue - totalCost;
  const remainingStock = products.reduce((s,p)=>s+(p.stock||0),0);

  document.getElementById('sKpiRevenue').innerText = totalRevenue.toLocaleString();
  document.getElementById('sKpiCost').innerText = totalCost.toLocaleString();
  document.getElementById('sKpiGain').innerText = totalGain.toLocaleString();
  document.getElementById('sKpiStock').innerText = remainingStock;

  // Top Selling Products
  const prodMap = {};
  sales.forEach(s=>{ 
    if(!prodMap[s.productName]) prodMap[s.productName] = 0; 
    prodMap[s.productName] += s.qty || 0;
  });
  const topProducts = Object.entries(prodMap).sort((a,b)=>b[1]-a[1]);
  const labels = topProducts.map(a=>a[0]);
  const data = topProducts.map(a=>a[1]);
  destroyIf(chartTopSelling);
  const ctx1 = document.getElementById('chartTopSelling');
  chartTopSelling = new Chart(ctx1, { type:'bar', data:{ labels, datasets:[{ label:'Qty Sold', data }] } });

  // Payment Method Pie
  const payMap = {};
  sales.forEach(s=>{ payMap[s.payment] = (payMap[s.payment]||0) + (s.revenue||0); });
  const payLabels = Object.keys(payMap);
  const payData = Object.values(payMap);
  destroyIf(chartPaymentMethod);
  const ctx2 = document.getElementById('chartPaymentMethod');
  chartPaymentMethod = new Chart(ctx2, { type:'pie', data:{ labels:payLabels, datasets:[{ data:payData }] } });
}

// Export Sales Excel
async function exportSalesExcel(){
  const snap = await db.collection('sales').get();
  const aoa = [["Product","Barcode","Qty","Payment","Customer","Revenue","Cost","Gain","Date/Time","Note"]];
  snap.docs.forEach(d=>{
    const x=d.data();
    aoa.push([x.productName,x.productId,x.qty,x.payment,x.customer,x.revenue,x.cost,x.gain,x.timestamp?.toDate().toLocaleString(),x.note||'']);
  });
  const ws = XLSX.utils.aoa_to_sheet(aoa);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Sales");
  XLSX.writeFile(wb, `sales_${Date.now()}.xlsx`);
}

// Helpers
function destroyIf(chart){ if(chart){ try{ chart.destroy(); }catch(e){} } }

// Initial load
loadSales();
loadSalesAnalytics();
</script>

<style>
.red-stock{color:red;font-weight:700;}
</style>
